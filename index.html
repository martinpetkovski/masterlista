<!DOCTYPE html>
<html lang="mk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Македонска Музичка Топ Листа | Најпопуларни Македонски Песни</title>
    
    <!-- Primary SEO Meta Tags -->
    <meta name="title" content="Македонска Музичка Топ Листа | Најпопуларни Македонски Песни">
    <meta name="description" content="Откријте ги најпопуларните македонски песни и албуми. Топ листа на сингли, албуми и нови изданија од македонската музичка сцена. Ажурирано неделно.">
    <meta name="keywords" content="македонска музика, топ листа, македонски песни, македонски албуми, музичка листа, македонски артисти, нови изданија, македонска музичка сцена">
    <meta name="author" content="Македонска Музичка Мастер Листа">
    <meta name="robots" content="index, follow">
    <meta name="language" content="Macedonian">
    <meta name="revisit-after" content="7 days">
    <link rel="canonical" href="https://toplista.mk/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://toplista.mk/">
    <meta property="og:title" content="Македонска Музичка Топ Листа | Најпопуларни Македонски Песни">
    <meta property="og:description" content="Откријте ги најпопуларните македонски песни и албуми. Топ листа на сингли, албуми и нови изданија од македонската музичка сцена.">
    <meta property="og:image" content="https://toplista.mk/og-image.png">
    <meta property="og:locale" content="mk_MK">
    <meta property="og:site_name" content="Топ Листа МК">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://toplista.mk/">
    <meta property="twitter:title" content="Македонска Музичка Топ Листа">
    <meta property="twitter:description" content="Откријте ги најпопуларните македонски песни и албуми. Топ листа од македонската музичка сцена.">
    <meta property="twitter:image" content="https://toplista.mk/og-image.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    <!-- Structured Data / JSON-LD -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "Македонска Музичка Топ Листа",
        "alternateName": "Топ Листа МК",
        "url": "https://toplista.mk/",
        "description": "Топ листа на најпопуларни македонски песни, албуми и нови изданија",
        "inLanguage": "mk",
        "publisher": {
            "@type": "Organization",
            "name": "Македонска Музичка Мастер Листа"
        }
    }
    </script>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "ItemList",
        "name": "Македонска Музичка Топ Листа",
        "description": "Неделна листа на најпопуларни македонски сингли и албуми",
        "itemListElement": []
    }
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@600;700;800&family=Bungee&family=JetBrains+Mono:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="desktop.css" media="screen and (min-width: 601px)">
    <link rel="stylesheet" href="mobile.css" media="screen and (max-width: 600px)">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Dark mode variables */
        body.dark-mode {
            --bg-primary: #0c1014;
            --bg-secondary: #141a1f;
            --bg-hover: #1c2428;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --text-muted: #5f6368;
            --border-color: #2d3439;
            --accent-blue: #0095f6;
            --accent-green: #51cf66;
            --accent-orange: #e07800;
            --accent-red: #ed4956;
            --accent-purple: #9775fa;
            --accent-teal: #20c997;
        }
        
        body.dark-mode .chart-section-header {
            background: #000;
            color: #fff;
        }
        
        body.dark-mode .chart-section-header h2 {
            color: #fff;
        }
        
        body.dark-mode .share-card {
            background: #141a1f;
        }
        
        body.dark-mode .share-card-list {
            background: #141a1f;
        }
        
        body.dark-mode .share-card-item {
            border-color: #2d3439;
        }
        
        body.dark-mode .share-card-rank {
            color: #5f6368;
        }
        
        body.dark-mode .share-card-rank.gold { color: #ffd700; }
        body.dark-mode .share-card-rank.silver { color: #c0c0c0; }
        body.dark-mode .share-card-rank.bronze { color: #cd7f32; }
        
        body.dark-mode .share-card-song {
            color: #e8eaed;
        }
        
        body.dark-mode .share-card-artist {
            color: #9aa0a6;
        }
        
        body.dark-mode .share-card-footer {
            background: #1c2428;
            border-color: #2d3439;
        }
        
        body.dark-mode .share-card-date,
        body.dark-mode .share-card-url {
            color: #5f6368;
        }
        
        body.dark-mode .chart-section {
            background: #141a1f;
            border-color: #2d3439;
        }
        
        body.dark-mode .chart-item {
            border-color: #2d3439;
        }
        
        body.dark-mode .chart-item:hover {
            background: #1c2428;
        }
        
        body.dark-mode .chart-title {
            color: #e8eaed;
        }
        
        body.dark-mode .chart-artist {
            color: #9aa0a6;
        }
        
        body.dark-mode .chart-artist-link {
            color: #9aa0a6;
        }
        
        body.dark-mode .chart-artist-link:hover {
            color: #e07800;
        }
        
        body.dark-mode .chart-stat.followers {
            color: #e07800;
            text-shadow: 0 0 25px rgba(224, 120, 0, 0.4);
        }
        
        body.dark-mode .chart-stat.weeks {
            color: #64748b;
        }
        
        body.dark-mode .chart-cover .placeholder {
            background: #1c2428;
            color: #5f6368;
        }
        
        body.dark-mode .share-modal-content {
            background: #141a1f;
        }
        
        body.dark-mode .share-modal-header h3 {
            color: #e8eaed;
        }
        
        body.dark-mode .share-action-btn {
            background: #1c2428;
            color: #e8eaed;
            border-color: #2d3439;
        }
        
        body.dark-mode .share-action-btn:hover {
            background: #2d3439;
        }
        
        body.dark-mode .view-mode-toggle {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.15);
            color: #e8eaed;
        }
        
        body.dark-mode .view-mode-toggle:hover {
            background: rgba(255,255,255,0.15);
        }
        
        body.dark-mode .chart-loading,
        body.dark-mode .chart-empty {
            color: #9aa0a6;
        }
        
        body.dark-mode .share-btn {
            background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.08) 100%);
            border-color: rgba(255,255,255,0.2);
            color: #e8eaed;
        }
        
        body.dark-mode .share-btn:hover {
            background: linear-gradient(180deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.15) 100%);
        }
        
        /* Dark mode for chart sections and items */
        body.dark-mode .chart-section {
            background: #141a1f;
            border-color: #2d3439;
        }
        
        body.dark-mode .chart-item {
            background: transparent;
            border-color: #2d3439;
        }
        
        body.dark-mode .chart-item:hover {
            background: #1c2428;
        }
        
        body.dark-mode .chart-cover {
            background: #1c2428;
        }
        
        body.dark-mode .chart-title {
            color: #e8eaed;
        }
        
        body.dark-mode .chart-artist-link {
            color: #9aa0a6;
        }
        
        body.dark-mode .chart-release-type {
            background: #1c2428;
            color: #9aa0a6;
        }
        
        body.dark-mode .share-modal-content {
            background: #141a1f;
            border-color: #2d3439;
        }
        
        body.dark-mode .share-actions button {
            background: #1c2428;
            border-color: #2d3439;
            color: #e8eaed;
        }
        
        body.dark-mode .share-actions button:hover {
            background: #2d3439;
        }
        
        body.dark-mode .share-modal-close {
            color: #9aa0a6;
        }
        
        body.dark-mode .share-modal-close:hover {
            color: #e8eaed;
        }
        
        body.dark-mode .cache-info {
            color: #5f6368;
        }
        
        /* Chart page icon-only buttons */
        .chart-page .header-btn {
            font-size: 0;
            width: 34px;
            height: 34px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            position: relative;
        }
        
        .chart-page .header-btn i {
            font-size: 0.9rem;
        }
        
        /* Tooltip for buttons on chart page */
        .chart-page .header-btn[title]::after {
            content: attr(title);
            position: absolute;
            top: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            padding: 0.35rem 0.6rem;
            background: linear-gradient(180deg, #343a40 0%, #212529 100%);
            color: #fff;
            font-size: 0.7rem;
            font-weight: 600;
            white-space: nowrap;
            border-radius: 6px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s ease;
            z-index: 1000;
            pointer-events: none;
        }
        
        .chart-page .header-btn[title]::before {
            content: '';
            position: absolute;
            top: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: #343a40;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s ease;
            z-index: 1000;
        }
        
        .chart-page .header-btn[title]:hover::after,
        .chart-page .header-btn[title]:hover::before {
            opacity: 1;
            visibility: visible;
        }
        
        .chart-page .header-btn:hover {
            transform: translateY(-1px);
        }
        
        /* Dark mode toggle button */
        .dark-mode-toggle {
            background: linear-gradient(180deg, var(--bg-primary) 0%, rgba(0,0,0,0.05) 100%);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            width: 34px;
            height: 34px;
            padding: 0;
            font-size: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            transition: all 0.2s ease;
        }
        
        .dark-mode-toggle i {
            font-size: 0.9rem;
        }
        
        .dark-mode-toggle:hover {
            background: linear-gradient(180deg, var(--bg-hover) 0%, rgba(0,0,0,0.08) 100%);
            transform: translateY(-1px);
        }
        
        body.dark-mode .dark-mode-toggle {
            background: #1c2428;
            border-color: #2d3439;
        }
        
        body.dark-mode .dark-mode-toggle:hover {
            background: #2d3439;
        }
        
        /* Dark mode header buttons */
        body.dark-mode.chart-page .header-btn {
            background: #1c2428;
            border-color: #2d3439;
            color: var(--text-primary);
        }
        
        body.dark-mode.chart-page .header-btn:hover {
            background: #2d3439;
        }
        
        body.chart-page {
            overflow: hidden;
            height: 100vh;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: 
                radial-gradient(ellipse at 0% 0%, rgba(103, 126, 234, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 100% 0%, rgba(250, 82, 82, 0.06) 0%, transparent 40%),
                radial-gradient(ellipse at 100% 100%, rgba(18, 184, 134, 0.07) 0%, transparent 50%),
                radial-gradient(ellipse at 0% 100%, rgba(121, 80, 242, 0.06) 0%, transparent 45%),
                radial-gradient(ellipse at 50% 50%, rgba(253, 126, 20, 0.04) 0%, transparent 60%),
                linear-gradient(180deg, #f8fafc 0%, #eef2f7 25%, #e8ecf2 50%, #e2e8ef 75%, #dce3eb 100%);
        }
        
        body.dark-mode.chart-page {
            background: #0c1014;
        }
        
        /* Chart Filter Bar */
        .chart-filter-bar {
            background: linear-gradient(180deg, #f0f2f5 0%, #e8ebef 100%);
            border-bottom: 1px solid rgba(0,0,0,0.08);
            padding: 0.5rem 1rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        body.dark-mode .chart-filter-bar {
            background: linear-gradient(180deg, #1c2428 0%, #141a1f 100%);
            border-bottom-color: rgba(255,255,255,0.08);
        }
        
        .chart-filter-content {
            display: flex;
            align-items: center;
            gap: 1rem;
            max-width: 100%;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            flex-shrink: 0;
        }
        
        .filter-label {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: 0.2rem;
        }
        
        .filter-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.35rem 0.65rem;
            font-size: 0.7rem;
            font-weight: 500;
            border: 1px solid rgba(0,0,0,0.12);
            border-radius: 16px;
            background: rgba(255,255,255,0.8);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
        }
        
        .filter-btn:hover {
            background: rgba(255,255,255,1);
            border-color: rgba(0,0,0,0.2);
            color: var(--text-primary);
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, var(--accent-orange) 0%, #fd7e14 100%);
            border-color: var(--accent-orange);
            color: #fff;
        }
        
        .filter-btn.reset-btn {
            background: transparent;
            border-color: rgba(0,0,0,0.2);
            color: var(--text-muted);
            font-size: 0.65rem;
            padding: 0.3rem 0.5rem;
        }
        
        .filter-btn.reset-btn:hover {
            background: rgba(0,0,0,0.05);
            color: var(--text-primary);
        }
        
        body.dark-mode .filter-btn.reset-btn {
            border-color: rgba(255,255,255,0.15);
            color: var(--text-muted);
        }
        
        body.dark-mode .filter-btn.reset-btn:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }
        
        .filter-btn i {
            font-size: 0.65rem;
        }
        
        body.dark-mode .filter-btn {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.12);
            color: var(--text-secondary);
        }
        
        body.dark-mode .filter-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.2);
            color: var(--text-primary);
        }
        
        body.dark-mode .filter-btn.active {
            background: linear-gradient(135deg, var(--accent-orange) 0%, #fd7e14 100%);
            border-color: var(--accent-orange);
            color: #fff;
        }
        
        /* Current filter indicator */
        .chart-filter-indicator {
            font-size: 0.65rem;
            color: var(--accent-orange);
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 0.3rem;
            padding: 0.25rem 0.5rem;
            background: rgba(224, 120, 0, 0.1);
            border-radius: 4px;
        }
        
        .chart-filter-indicator.visible {
            display: inline-flex;
        }
        
        @media (max-width: 600px) {
            .chart-filter-bar {
                padding: 0.4rem 0.5rem;
                overflow-x: auto;
                scrollbar-width: none;
                -ms-overflow-style: none;
                flex-shrink: 0;
            }
            
            .chart-filter-bar::-webkit-scrollbar {
                display: none;
            }
            
            .chart-filter-content {
                gap: 0.4rem;
                flex-wrap: nowrap;
                padding-right: 0.5rem;
                min-width: max-content;
            }
            
            .filter-group {
                gap: 0.2rem;
                flex-shrink: 0;
            }
            
            .filter-label {
                font-size: 0.5rem;
                display: none; /* Hide labels on mobile to save space */
            }
            
            .filter-btn {
                padding: 0.28rem 0.45rem;
                font-size: 0.58rem;
                border-radius: 12px;
                white-space: nowrap;
            }
            
            .reset-btn {
                padding: 0.28rem 0.4rem;
            }
            
            .reset-btn i {
                margin-right: 0;
            }
        }
        
        .chart-container {
            max-width: 100%;
            padding: 0.85rem 1.25rem;
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.65rem;
            padding: 0 0.35rem;
        }
        
        .chart-header h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .chart-header h1 i { color: var(--accent-orange); font-size: 0.8rem; }
        
        .chart-header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .cache-info {
            font-size: 0.65rem;
            color: var(--text-muted);
        }
        
        .chart-sections {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: 1fr;
            gap: 1rem;
            flex: 1;
            min-height: 0;
            height: 0;
            overflow: hidden;
        }
        
        .chart-section {
            background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(248,249,250,0.9) 100%);
            border: 1px solid rgba(222, 226, 230, 0.6);
            border-radius: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
            max-height: 100%;
            transition: all 0.2s ease;
        }
        
        .chart-section-header {
            background: linear-gradient(135deg, #FAFAFA 0%, #DDD 100%);
            color: #000;
            padding: 0.6rem 0.85rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            position: relative;
        }
        
        .chart-section-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent 0%, rgba(0,0,0,0.2) 50%, transparent 100%);
        }
        
        .chart-section-header h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }
        
        .chart-section-header h2 i { font-size: 0.75rem; }
        
        .chart-section-header .period {
            font-size: 0.65rem;
            opacity: 0.9;
            font-weight: 500;
        }
        
        .chart-header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .share-btn {
            background: linear-gradient(180deg, rgba(0,0,0,0.08) 0%, rgba(0,0,0,0.15) 100%);
            border: 1px solid rgba(0,0,0,0.15);
            border-radius: 6px;
            color: #212529;
            padding: 0.4rem 0.7rem;
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: all 0.15s ease;
        }
        
        .share-btn:hover {
            background: linear-gradient(180deg, rgba(0,0,0,0.15) 0%, rgba(0,0,0,0.22) 100%);
        }
        
        .share-btn i {
            font-size: 0.65rem;
        }
        
        .share-btn.sharing {
            pointer-events: none;
            opacity: 0.7;
        }
        
        /* Share modal/preview */
        .share-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
        }
        
        .share-modal.active {
            display: flex;
        }
        
        .share-modal-content {
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            border-radius: 10px;
            max-width: 420px;
            max-height: 85vh;
            overflow: auto;
            position: relative;
            backdrop-filter: blur(20px);
        }
        
        .share-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.6rem 0.85rem;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, transparent 100%);
        }
        
        .share-modal-header h3 {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8rem;
            font-weight: 800;
        }
        
        .share-modal-close {
            background: linear-gradient(180deg, rgba(0,0,0,0.05) 0%, rgba(0,0,0,0.1) 100%);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            padding: 0.25rem 0.4rem;
            transition: all 0.15s ease;
        }
        
        .share-modal-close:hover {
            color: var(--text-primary);
            background: linear-gradient(180deg, rgba(0,0,0,0.08) 0%, rgba(0,0,0,0.15) 100%);
        }
        
        .share-preview {
            padding: 0.75rem;
            display: flex;
            justify-content: center;
            background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.02) 100%);
        }
        
        .share-preview img {
            max-width: 100%;
            max-height: 350px;
            border-radius: 6px;
        }
        
        .share-actions {
            display: flex;
            gap: 0.5rem;
            padding: 0.6rem 0.85rem;
            border-top: 1px solid var(--border-color);
            justify-content: center;
            flex-wrap: wrap;
            background: linear-gradient(180deg, rgba(0,0,0,0.02) 0%, rgba(0,0,0,0.05) 100%);
        }
        
        .share-action-btn {
            background: linear-gradient(180deg, var(--accent-orange) 0%, #fd7e14 100%);
            border: none;
            border-radius: 6px;
            color: #fff;
            padding: 0.45rem 0.9rem;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: all 0.15s ease;
        }
        
        .share-action-btn.download {
            background: linear-gradient(180deg, var(--accent-blue) 0%, #1864ab 100%);
        }
        
        .share-action-btn.copy {
            background: linear-gradient(180deg, var(--accent-purple) 0%, #7048e8 100%);
        }
        
        /* Shareable chart card (hidden, used for rendering) */
        .share-card {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 420px;
            background: #fff;
            padding: 0;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            border: none;
        }
        
        .share-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #FAFAFA 0%, #DDD 100%);
        }
        
        .share-card-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: #000;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .share-card-title i {
            font-size: 0.9rem;
        }
        
        .share-card-branding {
            font-size: 0.55rem;
            color: rgba(0,0,0,0.7);
            text-align: right;
            line-height: 1.3;
        }
        
        .share-card-branding .mmm {
            font-family: 'Bungee', sans-serif;
            font-size: 0.8rem;
            background: none;
            color: #fa5252;
            -webkit-text-fill-color: #fa5252;
            display: block;
            margin-bottom: 2px;
            text-shadow: 1px 1px 2px rgba(250, 82, 82, 0.3);
        }
        
        .share-card-list {
            list-style: none;
            padding: 0.5rem 0;
            margin: 0;
            background: #fff;
        }
        
        .share-card-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            gap: 0.6rem;
            border-bottom: 1px solid #eee;
        }
        
        .share-card-item:last-child {
            border-bottom: none;
        }
        
        .share-card-item:nth-child(1) {
            background: linear-gradient(90deg, rgba(255,215,0,0.15) 0%, transparent 100%);
        }
        
        .share-card-item:nth-child(2) {
            background: linear-gradient(90deg, rgba(192,192,192,0.12) 0%, transparent 100%);
        }
        
        .share-card-item:nth-child(3) {
            background: linear-gradient(90deg, rgba(205,127,50,0.12) 0%, transparent 100%);
        }
        
        .share-card-rank {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 800;
            width: 24px;
            text-align: right;
            color: #999;
        }
        
        .share-card-rank.gold { color: #d4a000; }
        .share-card-rank.silver { color: #888; }
        .share-card-rank.bronze { color: #a06020; }
        
        .share-card-cover {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
            background: #f0f0f0;
        }
        
        .share-card-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .share-card-info {
            flex: 1;
            min-width: 0;
        }
        
        .share-card-song {
            font-weight: 600;
            font-size: 0.9rem;
            color: #1a1a1a;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .share-card-artist {
            font-size: 0.75rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .share-card-footer {
            padding: 0.6rem 1rem;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top: 1px solid #eee;
        }
        
        .share-card-date {
            font-size: 0.65rem;
            color: #888;
        }
        
        .share-card-url {
            font-size: 0.6rem;
            color: #aaa;
        }
        
        .chart-list-wrapper {
            position: relative;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }
        
        /* Chart list scroll shadows - disabled */
        .chart-list-wrapper::before,
        .chart-list-wrapper::after {
            display: none;
        }
        
        .chart-list-wrapper.scroll-top::before { opacity: 0; }
        .chart-list-wrapper.scroll-bottom::after { opacity: 0; }
        
        .chart-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: calc(100vh - 180px);
            overflow-y: auto;
        }
        
        .chart-list::-webkit-scrollbar { width: 4px; }
        .chart-list::-webkit-scrollbar-track { background: var(--bg-secondary); }
        .chart-list::-webkit-scrollbar-thumb { background: var(--border-color); }
        
        .chart-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.85rem 0.5rem 0.5rem;
            border-bottom: 1px solid var(--border-color);
            gap: 0.45rem;
            transition: all 0.15s ease;
            background: linear-gradient(90deg, rgba(255,255,255,0.5) 0%, transparent 100%);
        }
        
        .chart-item:last-child { border-bottom: none; }
        .chart-item:hover { 
            background: linear-gradient(90deg, var(--bg-hover) 0%, rgba(255,255,255,0.3) 100%);
        }
        
        .chart-rank {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4rem;
            font-weight: 800;
            width: 36px;
            text-align: center;
            flex-shrink: 0;
            color: var(--text-muted);
            position: relative;
        }
        
        /* Position change indicators via arrow superscript - absolutely positioned */
        .chart-rank.rank-up::after {
            content: '▲';
            position: absolute;
            top: -8px;
            right: -2px;
            font-size: 0.8rem;
            font-weight: 900;
            color: #1DB954;
            line-height: 1;
            text-shadow: 0 0 10px rgba(29, 185, 84, 0.35);
        }
        
        .chart-rank.rank-down::after {
            content: '▼';
            position: absolute;
            top: -8px;
            right: -2px;
            font-size: 0.8rem;
            font-weight: 900;
            color: #e74c3c;
            line-height: 1;
            text-shadow: 0 0 10px rgba(231, 76, 60, 0.35);
        }
        
        .chart-rank.gold { 
            color: #d4a000; 
        }
        .chart-rank.silver { 
            color: #8a8a8a; 
        }
        .chart-rank.bronze { 
            color: #a86830; 
        }
        
        .chart-item.rank-1 { background: linear-gradient(90deg, rgba(255,215,0,0.12) 0%, rgba(255,215,0,0.03) 60%, transparent 100%); }
        .chart-item.rank-2 { background: linear-gradient(90deg, rgba(192,192,192,0.12) 0%, rgba(192,192,192,0.03) 60%, transparent 100%); }
        .chart-item.rank-3 { background: linear-gradient(90deg, rgba(205,127,50,0.12) 0%, rgba(205,127,50,0.03) 60%, transparent 100%); }
        
        .chart-cover {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
            background: var(--bg-secondary);
            transition: all 0.15s ease;
        }
        
        .chart-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .chart-cover .placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1DB954, #191414);
            color: rgba(255,255,255,0.5);
            font-size: 0.7rem;
        }
        
        .chart-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }
        
        .chart-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .chart-title:hover {
            color: #e07800;
        }
        
        .chart-artist {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chart-artist-link {
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.15s ease;
        }
        
        .chart-artist-link:hover {
            color: #e07800;
            text-decoration: none;
        }
        
        /* Artist chart specific styles */
        .artist-item .artist-cover {
            border-radius: 50%;
        }
        
        .artist-item .artist-cover img {
            border-radius: 50%;
        }
        
        .artist-item .artist-name a {
            color: var(--text-primary);
            text-decoration: none;
            transition: color 0.15s ease;
        }
        
        .artist-item .artist-name a:hover {
            color: #e07800;
        }
        
        .artist-item .artist-details {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .artist-item .chart-stat.followers {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .artist-item .chart-stat.followers i {
            font-size: 0.7rem;
            opacity: 0.7;
        }
        
        /* All-time section takes full width */
        .alltime-section {
            grid-column: 1 / -1;
        }
        
        .chart-release-type {
            display: inline-block;
            font-size: 0.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-orange) 0%, #fd7e14 100%);
            color: #fff;
            padding: 0.08rem 0.25rem;
            border-radius: 3px;
            margin-left: 0.2rem;
            vertical-align: middle;
        }
        
        .chart-release-type.album { 
            background: linear-gradient(135deg, var(--accent-purple) 0%, #7048e8 100%); 
        }
        .chart-release-type.ep { 
            background: linear-gradient(135deg, var(--accent-blue) 0%, #1864ab 100%); 
        }
        
        /* Popularity change indicator - arrow overlays the number */
        .pop-change {
            position: absolute;
            top: 0%;
            left: 90%;
            font-size: 1rem;
            font-weight: 900;
            line-height: 1;
            color: transparent;
            pointer-events: none;
            z-index: 1;
        }
        
        .pop-change.up::before { 
            content: '▲';
            color: rgba(29, 185, 84, 0.85);
        }
        .pop-change.down::before { 
            content: '▼';
            color: rgba(231, 76, 60, 0.85);
        }
        
        /* New entry highlight */
        .chart-item.is-new {
            background: linear-gradient(90deg, rgba(255,215,0,0.1) 0%, rgba(255,215,0,0.02) 50%, transparent 100%);
        }
        
        .chart-item.is-new .chart-title::after {
            content: 'НОВО';
            font-size: 0.45rem;
            font-weight: 700;
            background: linear-gradient(135deg, #d4a000, #c47f00);
            color: #fff;
            padding: 0.1rem 0.25rem;
            border-radius: 3px;
            margin-left: 0.35rem;
            vertical-align: middle;
        }
        
        .chart-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        .chart-stat {
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', 'Fira Code', 'SF Mono', monospace;
            font-weight: 800;
            letter-spacing: -0.02em;
        }
        
        .chart-stat.weeks {
            display: inline-block;
            font-size: 0.7rem;
            color: #94a3b8;
            min-width: 26px;
            text-align: right;
        }
        
        .chart-stat.followers {
            position: relative;
            font-size: 1.6rem;
            font-weight: 800;
            color: #94a3b8;
            min-width: 36px;
            text-align: right;
            cursor: default;
            text-shadow: 0 0 20px rgba(224, 120, 0, 0.3);
        }
        
        .chart-stat i { display: none; }
        

        
        .chart-loading, .chart-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.75rem;
            background: linear-gradient(180deg, rgba(0,0,0,0.02) 0%, rgba(0,0,0,0.05) 100%);
            border-radius: 8px;
            margin: 0.5rem;
        }
        
        .chart-loading i, .chart-empty i {
            font-size: 1.25rem;
            color: var(--accent-blue);
            margin-bottom: 0.75rem;
            display: block;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.65rem;
            padding: 0.35rem 0.6rem;
            border-radius: 6px;
            transition: all 0.15s ease;
            background: linear-gradient(180deg, rgba(0,0,0,0.02) 0%, rgba(0,0,0,0.05) 100%);
        }
        
        .back-link:hover { 
            color: var(--accent-blue); 
            background: linear-gradient(180deg, rgba(34,139,230,0.08) 0%, rgba(34,139,230,0.15) 100%);
        }
        
        /* Mobile adjustments */
        @media (max-width: 900px) {
            .chart-sections { 
                grid-template-columns: 1fr;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                overflow: hidden;
                flex: 1;
                min-height: 0;
            }
            .chart-section {
                flex: 1;
                min-height: 0;
                display: flex;
                flex-direction: column;
            }
            .chart-list { 
                max-height: calc(50vh - 80px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            /* Hide albums on mobile */
            .chart-section#albums-section {
                display: none !important;
            }
        }
        
        @media (max-width: 600px) {
            .chart-container { 
                padding: 0.5rem; 
                padding-bottom: calc(0.5rem + env(safe-area-inset-bottom, 0px));
            }
            .chart-header h1 { font-size: 0.8rem; }
            .chart-item { padding: 0.2rem 0.35rem; }
            .chart-cover { width: 24px; height: 24px; }
            
            /* Mobile header buttons - more compact */
            .chart-section-header {
                padding: 0.5rem 0.65rem;
            }
            .chart-section-header h2 {
                font-size: 0.75rem;
            }
            .chart-header-right {
                gap: 0.35rem;
            }
            .chart-section-header .period {
                font-size: 0.55rem;
            }
            .share-btn {
                padding: 0.35rem 0.5rem;
                font-size: 0.65rem;
            }
            .share-btn span {
                display: none;
            }
            .view-mode-toggle {
                padding: 0.35rem 0.5rem;
            }
        }
        
        /* Compact/Expanded mode toggle */
        .view-mode-toggle {
            background: linear-gradient(180deg, rgba(0,0,0,0.08) 0%, rgba(0,0,0,0.15) 100%);
            border: 1px solid rgba(0,0,0,0.15);
            border-radius: 6px;
            color: #212529;
            padding: 0.4rem 0.6rem;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: all 0.15s ease;
        }
        
        .view-mode-toggle:hover {
            background: linear-gradient(180deg, rgba(0,0,0,0.15) 0%, rgba(0,0,0,0.22) 100%);
        }
        
        .view-mode-toggle i { font-size: 0.7rem; }
        
        /* Compact mode styles - single row layout */
        .chart-section.compact-mode .chart-item {
            padding: 0.2rem 0.5rem;
            gap: 0.35rem;
        }
        
        .chart-section.compact-mode .chart-cover {
            width: 28px;
            height: 28px;
            border-radius: 3px;
        }
        
        .chart-section.compact-mode .chart-rank {
            font-size: 0.7rem;
            width: 16px;
        }

        .chart-section.compact-mode .chart-rank.rank-up::after,
        .chart-section.compact-mode .chart-rank.rank-down::after {
            top: -6px;
            right: -2px;
            font-size: 0.65rem;
        }
        
        .chart-section.compact-mode .chart-change {
            width: 18px;
            font-size: 0.6rem;
        }
        
        /* Single row: title and artist inline */
        .chart-section.compact-mode .chart-info {
            flex-direction: row;
            align-items: center;
            gap: 0.35rem;
        }
        
        .chart-section.compact-mode .chart-title {
            font-size: 0.75rem;
            flex-shrink: 1;
        }
        
        .chart-section.compact-mode .chart-artist {
            font-size: 0.7rem;
            flex-shrink: 2;
            opacity: 0.7;
        }
        
        .chart-section.compact-mode .chart-artist::before {
            content: '•';
            margin-right: 0.35rem;
            opacity: 0.5;
        }
        
        .chart-section.compact-mode .chart-meta {
            gap: 0.4rem;
        }
        
        .chart-section.compact-mode .chart-stat.weeks {
            font-size: 0.55rem;
            min-width: 20px;
        }
        
        .chart-section.compact-mode .chart-stat.followers {
            font-size: 1rem;
            min-width: 28px;
        }
        
        .chart-section.compact-mode .pop-change {
            font-size: 0.45rem;
            margin-left: 1px;
        }

        .chart-section.compact-mode .pop-change.up::before,
        .chart-section.compact-mode .pop-change.down::before {
            font-size: 0.45rem;
        }
        
        /* Mobile compact - even more compact, single row */
        @media (max-width: 600px) {
            .chart-section.compact-mode .chart-item {
                padding: 0.15rem 0.35rem;
                gap: 0.2rem;
            }
            
            .chart-section.compact-mode .chart-cover {
                width: 24px;
                height: 24px;
            }
            
            .chart-section.compact-mode .chart-rank {
                font-size: 0.65rem;
                width: 14px;
            }
            
            .chart-section.compact-mode .chart-change {
                width: 16px;
                font-size: 0.55rem;
            }
            
            .chart-section.compact-mode .chart-info {
                gap: 0.25rem;
            }
            
            .chart-section.compact-mode .chart-title {
                font-size: 0.7rem;
            }
            
            .chart-section.compact-mode .chart-artist {
                font-size: 0.6rem;
            }
            
            .chart-section.compact-mode .chart-stat.weeks {
                font-size: 0.5rem;
                min-width: 16px;
            }
            
            .chart-section.compact-mode .chart-stat.followers {
                font-size: 0.9rem;
                min-width: 24px;
            }
            
            .chart-section.compact-mode .pop-change {
                display: none;
            }
        }
        
        /* Inline music player - compact style */
        .music-player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, #1a2027 0%, #141a1f 100%);
            border-top: 1px solid rgba(255, 146, 43, 0.3);
            padding: 0;
            z-index: 5000;
            display: none;
            flex-direction: column;
        }
        
        body.dark-mode .music-player {
            background: linear-gradient(180deg, #1a2027 0%, #141a1f 100%);
        }
        
        .music-player.active {
            display: flex;
        }
        
        .music-player-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .music-player-cover {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .music-player-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .music-player-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
        }
        
        .music-player-title {
            font-weight: 600;
            font-size: 0.75rem;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .music-player-artist {
            font-size: 0.65rem;
            color: #9aa0a6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .music-player-services {
            display: flex;
            gap: 0.25rem;
            align-items: center;
            flex-shrink: 0;
        }
        
        .music-player-service {
            background: transparent;
            border: none;
            color: #6b7280;
            padding: 0;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }
        
        .music-player-service span {
            display: none;
        }
        
        .music-player-service:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #e8eaed;
        }
        
        .music-player-service.active {
            background: #e07800;
            color: #fff;
        }
        
        .music-player-service.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .music-player-service i {
            font-size: 1rem;
        }
        
        /* Service-specific colors on hover */
        .music-player-service[data-service="spotify"]:hover:not(.active) { color: #1DB954; }
        .music-player-service[data-service="youtube"]:hover:not(.active) { color: #FF0000; }
        .music-player-service[data-service="apple"]:hover:not(.active) { color: #fc3c44; }
        .music-player-service[data-service="deezer"]:hover:not(.active) { color: #FEAA2D; }
        .music-player-service[data-service="soundcloud"]:hover:not(.active) { color: #ff7700; }
        .music-player-service[data-service="bandcamp"]:hover:not(.active) { color: #1da0c3; }
        .music-player-service[data-service="tidal"]:hover:not(.active) { color: #00FFFF; }
        
        .music-player-remember {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.55rem;
            color: #6b7280;
            margin-left: 0.25rem;
            cursor: pointer;
            padding-left: 0.5rem;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .music-player-remember:hover {
            color: #9ca3af;
        }
        
        .music-player-remember input {
            accent-color: #e07800;
            width: 10px;
            height: 10px;
        }
        
        .music-player-close {
            background: transparent;
            border: none;
            color: #6b7280;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            flex-shrink: 0;
            font-size: 0.8rem;
            margin-left: 0.25rem;
        }
        
        .music-player-close:hover {
            background: rgba(255, 82, 82, 0.15);
            color: #fa5252;
        }
        
        .music-player-embed {
            width: 100%;
        }
        
        .music-player iframe {
            width: 100%;
            height: 80px;
            border: none;
        }
        
        .music-player iframe.youtube-embed,
        .music-player iframe.soundcloud-embed {
            height: 80px;
        }
        
        .music-player-external {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .music-player-external a {
            background: linear-gradient(180deg, #e07800 0%, #c96b00 100%);
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.15s ease;
        }
        
        .music-player-external a:hover {
            background: linear-gradient(180deg, #c96b00 0%, #b35f00 100%);
            transform: translateY(-1px);
        }
        
        .music-player-no-links {
            padding: 1rem;
            text-align: center;
            color: #6b7280;
            font-size: 0.75rem;
        }
        
        @media (max-width: 600px) {
            .music-player-header {
                padding: 0.3rem 0.5rem;
            }
            
            .music-player-cover {
                width: 28px;
                height: 28px;
            }
            
            .music-player-title {
                font-size: 0.7rem;
            }
            
            .music-player-artist {
                font-size: 0.6rem;
            }
            
            .music-player-service {
                width: 24px;
                height: 24px;
            }
            
            .music-player-service i {
                font-size: 0.85rem;
            }
            
            .music-player-remember {
                display: none;
            }
            
            .music-player-close {
                width: 24px;
                height: 24px;
            }
        }
    </style>
</head>
<body class="compact chart-page">
    <header>
        <div class="header-content">
            <div class="logo-title-group">
                <span class="site-logo-text">MMM</span>
                <div class="title-group">
                    <h1>Македонска Музичка Топ Листа</h1>
                    <div class="subtitle-stats">
                        <span>Ажурирано пред <span id="last-updated">...</span></span>
                    </div>
                </div>
            </div>
            <div class="header-buttons">
                <button id="dark-mode-toggle" class="dark-mode-toggle" title="Темен/Светол режим">
                    <i class="fas fa-moon"></i>
                </button>
                <a href="list.html" class="header-btn" title="Листа"><i class="fas fa-list"></i></a>
                <button id="start-tour-btn" class="header-btn tour-btn" title="Тура"><i class="fas fa-globe"></i></button>
            </div>
        </div>
    </header>
    
    <!-- Special Charts Filter -->
    <div class="chart-filter-bar">
        <div class="chart-filter-content">
            <div class="filter-group" data-filter-group="chart">
                <span class="filter-label">Листа:</span>
                <button class="filter-btn active" data-filter-type="chart" data-filter-value="standard" title="Стандардна листа">
                    Стандардна
                </button>
                <button class="filter-btn" data-filter-type="chart" data-filter-value="alltime" title="На сите времиња">
                    Сите времиња
                </button>
            </div>
            <div class="filter-group" data-filter-group="genre">
                <span class="filter-label">Жанр:</span>
                <button class="filter-btn active" data-filter-type="genre" data-filter-value="all" title="Сите жанрови">
                    Сите
                </button>
                <button class="filter-btn" data-filter-type="genre" data-filter-value="alt" title="Алтернативна музика">
                    Алтернативна
                </button>
                <button class="filter-btn" data-filter-type="genre" data-filter-value="rap" title="Рап и Трап">
                    Рап/Трап
                </button>
                <button class="filter-btn" data-filter-type="genre" data-filter-value="electronic" title="Електронска музика">
                    Електронска
                </button>
            </div>
            <div class="filter-group" data-filter-group="city">
                <span class="filter-label">Град:</span>
                <button class="filter-btn active" data-filter-type="city" data-filter-value="all" title="Сите градови">
                    Сите
                </button>
                <button class="filter-btn" data-filter-type="city" data-filter-value="skopje" title="Скопје">
                    Скопје
                </button>
                <button class="filter-btn" data-filter-type="city" data-filter-value="bitola" title="Битола">
                    Битола
                </button>
            </div>
            <button class="filter-btn reset-btn" id="reset-filters-btn" title="Ресетирај филтри">
                <i class="fas fa-undo"></i> Ресетирај
            </button>
        </div>
    </div>
    
    <div class="chart-container">
        
        <div class="chart-sections">
            <!-- Top Singles -->
            <div class="chart-section" id="singles-section">
                <div class="chart-section-header singles">
                    <h2><i class="fas fa-music"></i> Синглови</h2>
                    <div class="chart-header-right">
                        <span class="period" id="singles-period"></span>
                        <button class="view-mode-toggle" onclick="toggleViewMode('singles-section')" title="Компактен/Проширен приказ">
                            <i class="fas fa-compress-alt"></i>
                        </button>
                        <button class="share-btn" onclick="shareChart('singles')" title="Сподели">
                            <i class="fas fa-share-alt"></i> <span>Сподели</span>
                        </button>
                    </div>
                </div>
                <div class="chart-list-wrapper">
                    <div id="singles-chart-loading" class="chart-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Се вчитува...</p>
                    </div>
                    <ol id="singles-chart" class="chart-list" style="display: none;"></ol>
                    <div id="singles-chart-empty" class="chart-empty" style="display: none;">
                        <p>Нема синглови</p>
                    </div>
                </div>
            </div>
            
            <!-- Top Albums -->
            <div class="chart-section" id="albums-section">
                <div class="chart-section-header albums">
                    <h2><i class="fas fa-compact-disc"></i> Албуми</h2>
                    <div class="chart-header-right">
                        <span class="period" id="albums-period"></span>
                        <button class="view-mode-toggle" onclick="toggleViewMode('albums-section')" title="Компактен/Проширен приказ">
                            <i class="fas fa-compress-alt"></i>
                        </button>
                        <button class="share-btn" onclick="shareChart('albums')" title="Сподели">
                            <i class="fas fa-share-alt"></i> <span>Сподели</span>
                        </button>
                    </div>
                </div>
                <div class="chart-list-wrapper">
                    <div id="albums-chart-loading" class="chart-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Се вчитува...</p>
                    </div>
                    <ol id="albums-chart" class="chart-list" style="display: none;"></ol>
                    <div id="albums-chart-empty" class="chart-empty" style="display: none;">
                        <p>Нема албуми</p>
                    </div>
                </div>
            </div>
            
            <!-- Latest Releases -->
            <div class="chart-section" id="latest-section">
                <div class="chart-section-header">
                    <h2><i class="fas fa-clock"></i> Најнови</h2>
                    <div class="chart-header-right">
                        <span class="period" id="latest-period"></span>
                        <button class="view-mode-toggle" onclick="toggleViewMode('latest-section')" title="Компактен/Проширен приказ">
                            <i class="fas fa-compress-alt"></i>
                        </button>
                        <button class="share-btn" onclick="shareChart('latest')" title="Сподели">
                            <i class="fas fa-share-alt"></i> <span>Сподели</span>
                        </button>
                    </div>
                </div>
                <div class="chart-list-wrapper">
                    <div id="latest-chart-loading" class="chart-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Се вчитува...</p>
                    </div>
                    <ol id="latest-chart" class="chart-list" style="display: none;"></ol>
                    <div id="latest-chart-empty" class="chart-empty" style="display: none;">
                        <p>Нема изданија</p>
                    </div>
                </div>
            </div>
            
            <!-- All-Time Artists (hidden by default) -->
            <div class="chart-section alltime-section" id="artists-section" style="display: none;">
                <div class="chart-section-header artists">
                    <h2><i class="fas fa-users"></i> Топ Артисти</h2>
                    <div class="chart-header-right">
                        <span class="period" id="artists-period">сите времиња</span>
                        <button class="view-mode-toggle" onclick="toggleViewMode('artists-section')" title="Компактен/Проширен приказ">
                            <i class="fas fa-compress-alt"></i>
                        </button>
                        <button class="share-btn" onclick="shareChart('artists')" title="Сподели">
                            <i class="fas fa-share-alt"></i> <span>Сподели</span>
                        </button>
                    </div>
                </div>
                <div class="chart-list-wrapper">
                    <div id="artists-chart-loading" class="chart-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Се вчитува...</p>
                    </div>
                    <ol id="artists-chart" class="chart-list" style="display: none;"></ol>
                    <div id="artists-chart-empty" class="chart-empty" style="display: none;">
                        <p>Нема артисти</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Modal -->
    <div class="share-modal" id="share-modal">
        <div class="share-modal-content">
            <div class="share-modal-header">
                <h3 id="share-modal-title">Сподели листа</h3>
                <button class="share-modal-close" onclick="closeShareModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="share-preview" id="share-preview"></div>
            <div class="share-actions">
                <button class="share-action-btn" onclick="shareToNative()" id="native-share-btn">
                    <i class="fas fa-share"></i> Сподели
                </button>
                <button class="share-action-btn download" onclick="downloadShareImage()">
                    <i class="fas fa-download"></i> Преземи
                </button>
                <button class="share-action-btn copy" onclick="copyShareImage()">
                    <i class="fas fa-copy"></i> Копирај
                </button>
            </div>
        </div>
    </div>
    
    <!-- Hidden container for share card rendering -->
    <div id="share-card-container"></div>
    
    <script>
        // Global state for sharing
        let chartDataStore = {
            singles: [],
            albums: [],
            latest: []
        };
        let currentShareBlob = null;
        let currentShareType = null;
        
        const chartTitles = {
            singles: 'Топ Синглови',
            albums: 'Топ Албуми',
            latest: 'Најнови Изданија'
        };
        
        // View mode toggle function
        function toggleViewMode(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            
            const isCompact = section.classList.toggle('compact-mode');
            const btn = section.querySelector('.view-mode-toggle');
            if (btn) {
                btn.innerHTML = isCompact 
                    ? '<i class="fas fa-expand-alt"></i>' 
                    : '<i class="fas fa-compress-alt"></i>';
                btn.title = isCompact ? 'Проширен приказ' : 'Компактен приказ';
            }
            
            // Save preference
            const prefs = JSON.parse(localStorage.getItem('mmm-view-mode') || '{}');
            prefs[sectionId] = isCompact;
            localStorage.setItem('mmm-view-mode', JSON.stringify(prefs));
        }
        
        // Initialize view modes based on screen size and saved preferences
        function initViewModes() {
            const isMobile = window.innerWidth <= 600;
            const prefs = JSON.parse(localStorage.getItem('mmm-view-mode') || '{}');
            
            ['singles-section', 'albums-section', 'latest-section'].forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (!section) return;
                
                // Use saved preference, or default to compact on mobile
                const shouldBeCompact = prefs[sectionId] !== undefined ? prefs[sectionId] : isMobile;
                
                if (shouldBeCompact) {
                    section.classList.add('compact-mode');
                    const btn = section.querySelector('.view-mode-toggle');
                    if (btn) {
                        btn.innerHTML = '<i class="fas fa-expand-alt"></i>';
                        btn.title = 'Проширен приказ';
                    }
                }
            });
        }
        
        const chartIcons = {
            singles: 'fa-music',
            albums: 'fa-compact-disc',
            latest: 'fa-clock',
            artists: 'fa-users'
        };
        
        // Dynamic chart titles based on current filter
        function getChartTitle(chartType) {
            const baseTitles = {
                singles: 'Топ Синглови',
                albums: 'Топ Албуми',
                latest: 'Најнови Изданија',
                artists: 'Топ Артисти'
            };
            
            // Get current filter state from active buttons
            const chartBtn = document.querySelector('.filter-btn[data-filter-type="chart"].active');
            const genreBtn = document.querySelector('.filter-btn[data-filter-type="genre"].active');
            const cityBtn = document.querySelector('.filter-btn[data-filter-type="city"].active');
            
            const chartFilter = chartBtn?.dataset?.filterValue || 'standard';
            const genreFilter = genreBtn?.dataset?.filterValue || 'all';
            const cityFilter = cityBtn?.dataset?.filterValue || 'all';
            
            // Build filter suffix
            const genreLabels = { 'alt': 'Алтернативна', 'rap': 'Рап/Трап', 'electronic': 'Електронска' };
            const cityLabels = { 'skopje': 'Скопје', 'bitola': 'Битола' };
            
            const genreLabel = genreFilter !== 'all' ? genreLabels[genreFilter] : null;
            const cityLabel = cityFilter !== 'all' ? cityLabels[cityFilter] : null;
            const filterSuffix = [genreLabel, cityLabel].filter(Boolean).join(' • ');
            
            let title = baseTitles[chartType];
            
            // For all-time view
            if (chartFilter === 'alltime') {
                title = chartType === 'artists' ? 'Топ Артисти (Сите времиња)' : title + ' (Сите времиња)';
            }
            
            // Add genre/city suffix
            if (filterSuffix) {
                title += ' - ' + filterSuffix;
            }
            
            return title;
        }
        
        // Share functions
        async function shareChart(chartType) {
            const btn = event.target.closest('.share-btn');
            if (btn) btn.classList.add('sharing');
            
            try {
                const releases = chartDataStore[chartType];
                if (!releases || releases.length === 0) {
                    alert('Нема податоци за споделување');
                    return;
                }
                
                // Create share card with dynamic title
                const canvas = await createShareCard(chartType, releases.slice(0, 10), getChartTitle(chartType));
                
                // Convert to blob
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                currentShareBlob = blob;
                currentShareType = chartType;
                
                // Show preview modal
                const modal = document.getElementById('share-modal');
                const preview = document.getElementById('share-preview');
                const title = document.getElementById('share-modal-title');
                
                title.textContent = 'Сподели: ' + getChartTitle(chartType);
                
                // Create preview image
                const img = document.createElement('img');
                img.src = URL.createObjectURL(blob);
                preview.innerHTML = '';
                preview.appendChild(img);
                
                // Check if native share is supported
                const nativeShareBtn = document.getElementById('native-share-btn');
                if (navigator.share && navigator.canShare) {
                    nativeShareBtn.style.display = 'flex';
                } else {
                    nativeShareBtn.style.display = 'none';
                }
                
                modal.classList.add('active');
                
            } catch (err) {
                console.error('Error creating share image:', err);
                alert('Грешка при креирање на сликата');
            } finally {
                if (btn) btn.classList.remove('sharing');
            }
        }
        
        async function createShareCard(chartType, releases, customTitle = null) {
            const container = document.getElementById('share-card-container');
            const now = new Date();
            const monthNames = ['Јан', 'Фев', 'Мар', 'Апр', 'Мај', 'Јун', 'Јул', 'Авг', 'Сеп', 'Окт', 'Ное', 'Дек'];
            const dateStr = `${now.getDate()} ${monthNames[now.getMonth()]} ${now.getFullYear()}`;
            
            // Use custom title or fallback to default
            const chartTitle = customTitle || chartTitles[chartType] || 'Топ Листа';
            
            // Check if dark mode is active
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            // Theme colors - match exactly what's displayed
            const theme = isDarkMode ? {
                cardBg: '#141a1f',
                listBg: '#141a1f',
                itemBorder: '#2d3439',
                songColor: '#e8eaed',
                artistColor: '#9aa0a6',
                footerBg: '#1c2428',
                dateColor: '#5f6368',
                rankColor: '#5f6368',
                rankGold: '#ffd700',
                rankSilver: '#c0c0c0',
                rankBronze: '#cd7f32',
                coverBg: '#1c2428',
                headerBg: '#000',
                headerColor: '#fff',
                brandingColor: 'rgba(255,255,255,0.85)'
            } : {
                cardBg: '#fff',
                listBg: '#fff',
                itemBorder: '#eee',
                songColor: '#1a1a1a',
                artistColor: '#666',
                footerBg: '#f5f5f5',
                dateColor: '#888',
                rankColor: '#999',
                rankGold: '#d4a000',
                rankSilver: '#888',
                rankBronze: '#a06020',
                coverBg: '#f0f0f0',
                headerBg: 'linear-gradient(135deg, #FAFAFA 0%, #DDD 100%)',
                headerColor: '#000',
                brandingColor: 'rgba(0,0,0,0.7)'
            };
            
            // Preload images to ensure they're available for html2canvas
            const imagePromises = releases.map(release => {
                if (!release.thumbnail) return Promise.resolve(null);
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => resolve(img);
                    img.onerror = () => resolve(null);
                    img.src = release.thumbnail;
                });
            });
            
            await Promise.all(imagePromises);
            
            // Cache-busting timestamp for images
            const cacheBuster = Date.now();
            
            // Get rank color based on position
            const getRankColor = (rank) => {
                if (rank === 1) return theme.rankGold;
                if (rank === 2) return theme.rankSilver;
                if (rank === 3) return theme.rankBronze;
                return theme.rankColor;
            };
            
            // Get item background based on position
            const getItemBg = (rank) => {
                if (rank === 1) return isDarkMode ? 'linear-gradient(90deg, rgba(255,215,0,0.1) 0%, transparent 100%)' : 'linear-gradient(90deg, rgba(255,215,0,0.15) 0%, transparent 100%)';
                if (rank === 2) return isDarkMode ? 'linear-gradient(90deg, rgba(192,192,192,0.08) 0%, transparent 100%)' : 'linear-gradient(90deg, rgba(192,192,192,0.12) 0%, transparent 100%)';
                if (rank === 3) return isDarkMode ? 'linear-gradient(90deg, rgba(205,127,50,0.08) 0%, transparent 100%)' : 'linear-gradient(90deg, rgba(205,127,50,0.12) 0%, transparent 100%)';
                return 'transparent';
            };
            
            container.innerHTML = `
                <div class="share-card" id="share-card-render" style="background: ${theme.cardBg};">
                    <div class="share-card-header" style="background: ${theme.headerBg};">
                        <div class="share-card-title" style="color: ${theme.headerColor};">
                            <i class="fas ${chartIcons[chartType] || 'fa-users'}"></i>
                            ${chartTitle}
                        </div>
                        <div class="share-card-branding" style="color: ${theme.brandingColor};">
                            <span class="mmm">MMM</span>
                            Македонска Музичка<br>Мастер Листа
                        </div>
                    </div>
                    <ul class="share-card-list" style="background: ${theme.listBg};">
                        ${releases.map((release, index) => {
                            const rank = index + 1;
                            const thumbUrl = release.thumbnail ? `${release.thumbnail}${release.thumbnail.includes('?') ? '&' : '?'}cb=${cacheBuster}` : '';
                            
                            // Handle both releases and artists
                            const isArtist = chartType === 'artists';
                            const title = isArtist ? release.bandName : release.releaseTitle;
                            const subtitle = isArtist 
                                ? (release.followers >= 1000 ? (release.followers / 1000).toFixed(1) + 'K следбеници' : release.followers + ' следбеници')
                                : release.bandName;
                            const coverStyle = isArtist ? 'border-radius: 50%;' : '';
                            
                            return `
                                <li class="share-card-item" style="border-color: ${theme.itemBorder}; background: ${getItemBg(rank)};">
                                    <span class="share-card-rank" style="color: ${getRankColor(rank)};">${rank}</span>
                                    <div class="share-card-cover" style="background: ${theme.coverBg}; ${coverStyle}">
                                        ${thumbUrl 
                                            ? `<img src="${thumbUrl}" crossorigin="anonymous" alt="" style="${coverStyle}">`
                                            : ''
                                        }
                                    </div>
                                    <div class="share-card-info">
                                        <div class="share-card-song" style="color: ${theme.songColor};">${title}</div>
                                        <div class="share-card-artist" style="color: ${theme.artistColor};">${subtitle}</div>
                                    </div>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                    <div class="share-card-footer" style="background: ${theme.footerBg}; border-color: ${theme.itemBorder};">
                        <div class="share-card-date" style="color: ${theme.dateColor};">${dateStr}</div>
                        <div class="share-card-url" style="color: ${theme.dateColor};">toplista.mk</div>
                    </div>
                </div>
            `;
            
            const card = document.getElementById('share-card-render');
            
            // Use html2canvas to render the card
            const canvas = await html2canvas(card, {
                backgroundColor: null,
                scale: 2,
                useCORS: true,
                allowTaint: true,
                logging: false
            });
            
            // Clean up
            container.innerHTML = '';
            
            return canvas;
        }
        
        function closeShareModal() {
            const modal = document.getElementById('share-modal');
            modal.classList.remove('active');
            currentShareBlob = null;
            currentShareType = null;
        }
        
        async function shareToNative() {
            if (!currentShareBlob) return;
            
            try {
                const file = new File([currentShareBlob], `mmm-${currentShareType}-chart.png`, { type: 'image/png' });
                
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: chartTitles[currentShareType],
                        text: `${chartTitles[currentShareType]} - Македонска Музичка Мастер Листа`
                    });
                } else {
                    // Fallback to just sharing URL/text
                    await navigator.share({
                        title: chartTitles[currentShareType],
                        text: `${chartTitles[currentShareType]} - Македонска Музичка Мастер Листа`,
                        url: window.location.href
                    });
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Share failed:', err);
                }
            }
        }
        
        function downloadShareImage() {
            if (!currentShareBlob) return;
            
            const url = URL.createObjectURL(currentShareBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mmm-${currentShareType}-chart.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        async function copyShareImage() {
            if (!currentShareBlob) return;
            
            try {
                await navigator.clipboard.write([
                    new ClipboardItem({
                        'image/png': currentShareBlob
                    })
                ]);
                
                // Show feedback
                const btn = event.target.closest('.share-action-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Копирано!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            } catch (err) {
                console.error('Copy failed:', err);
                alert('Не може да се копира. Пробајте да преземете.');
            }
        }
        
        // Close modal on background click
        document.getElementById('share-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('share-modal')) {
                closeShareModal();
            }
        });
        
        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeShareModal();
            }
        });
        
        document.addEventListener('DOMContentLoaded', async () => {
            const CHART_DATA_URL = 'chart-data.json';
            const CHART_HISTORY_DIR = 'chart-history';
            
            const now = new Date();
            const twoMonthsAgo = new Date(now);
            twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
            
            const monthNames = ['Јан', 'Фев', 'Мар', 'Апр', 'Мај', 'Јун', 'Јул', 'Авг', 'Сеп', 'Окт', 'Ное', 'Дек'];
            const periodText = `${monthNames[twoMonthsAgo.getMonth()]} - ${monthNames[now.getMonth()]}`;
            document.getElementById('singles-period').textContent = periodText;
            document.getElementById('albums-period').textContent = periodText;
            document.getElementById('latest-period').textContent = `последни 20`;
            
            // Store previous chart data for comparison
            let previousChartData = null;
            
            // Store all releases data for filtering
            let allReleasesData = [];
            let allBandsData = [];
            
            // Current filter state (radio-button style - one selection per group)
            let currentFilters = {
                chart: 'standard',  // 'standard' or 'alltime'
                genre: 'all',       // 'all', 'alt', 'rap', 'electronic'
                city: 'all'         // 'all', 'skopje', 'bitola'
            };
            
            // Filter configuration - genre keywords to match in bands.json
            const genreConfig = {
                'alt': {
                    label: 'Алтернативна',
                    // Note: 'Рок' removed - only match specific sub-genres, not plain 'Рок'
                    genres: ['Алтернативен', 'Инди', 'Пост-панк', 'Панк', 'Шугејз', 'Дрим Поп', 'Пост-рок', 'Гранџ', 'Експериментален', 'Мат Рок', 'Арт Рок', 'Алтернативен Рок', 'Инди Рок', 'Пост-Панк']
                },
                'rap': {
                    label: 'Рап/Трап',
                    genres: ['Рап', 'Трап', 'Хип Хоп', 'Бум Бап']
                },
                'electronic': {
                    label: 'Електронска',
                    genres: ['Електронска', 'Техно', 'Хаус', 'Транс', 'Синтвејв', 'Синт-Поп', 'EDM', 'ДНБ', 'Драм', 'Амбиентална', 'Вејпорвејв']
                }
            };
            
            const cityConfig = {
                'skopje': { label: 'Скопје', city: 'Скопје' },
                'bitola': { label: 'Битола', city: 'Битола' }
            };
            
            /**
             * Get ISO week number and year for a given date.
             */
            function getISOWeek(date) {
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);
                d.setDate(d.getDate() + 4 - (d.getDay() || 7));
                const yearStart = new Date(d.getFullYear(), 0, 1);
                const weekNum = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                return { year: d.getFullYear(), week: weekNum };
            }
            
            /**
             * Get the previous week's ISO week number and year.
             */
            function getPreviousWeek(date) {
                const d = new Date(date);
                d.setDate(d.getDate() - 7); // Go back 7 days
                return getISOWeek(d);
            }
            
            function formatDataAge(isoString) {
                if (!isoString) return null;
                const generatedAt = new Date(isoString);
                const ageMs = Date.now() - generatedAt.getTime();
                const hours = Math.floor(ageMs / (60 * 60 * 1000));
                const minutes = Math.floor((ageMs % (60 * 60 * 1000)) / (60 * 1000));
                if (hours >= 24) {
                    const days = Math.floor(hours / 24);
                    return `пред ${days}д`;
                }
                if (hours > 0) return `пред ${hours}ч`;
                return `пред ${minutes}мин`;
            }
            
            function updateDataInfo(generatedAt) {
                const lastUpdated = document.getElementById('last-updated');
                const age = formatDataAge(generatedAt);
                if (lastUpdated) lastUpdated.textContent = age || '...';
            }
            
            // Build a lookup map for previous chart positions
            function buildPreviousChartMap(previousReleases, filterFn, sortFn, deduplicateFn) {
                if (!previousReleases || previousReleases.length === 0) return {};
                
                // Deduplicate collabs in previous data too
                const dedupedReleases = deduplicateFn ? deduplicateFn(previousReleases) : previousReleases;
                
                const releasesSortedByDate = [...dedupedReleases].sort((a, b) => 
                    new Date(b.releaseDate).getTime() - new Date(a.releaseDate).getTime()
                );
                
                const filtered = releasesSortedByDate.filter(filterFn).slice(0, 20);
                const sorted = [...filtered].sort(sortFn);
                
                const map = {};
                sorted.forEach((release, index) => {
                    map[release.releaseId] = {
                        position: index + 1,
                        popularity: release.popularity || 0
                    };
                });
                return map;
            }
            
            // Scroll shadow detection
            function initScrollShadows() {
                document.querySelectorAll('.chart-list').forEach(list => {
                    const wrapper = list.closest('.chart-list-wrapper');
                    if (!wrapper) return;
                    
                    const updateShadows = () => {
                        const { scrollTop, scrollHeight, clientHeight } = list;
                        wrapper.classList.toggle('scroll-top', scrollTop > 5);
                        wrapper.classList.toggle('scroll-bottom', scrollTop < scrollHeight - clientHeight - 5);
                    };
                    
                    list.addEventListener('scroll', updateShadows);
                    // Initial check after render
                    setTimeout(updateShadows, 100);
                });
            }
            
            async function loadPreviousData() {
                // Calculate previous week's filename
                const prevWeek = getPreviousWeek(now);
                const prevWeekFileName = `chart-${prevWeek.year}-W${String(prevWeek.week).padStart(2, '0')}.json`;
                const prevWeekUrl = `${CHART_HISTORY_DIR}/${prevWeekFileName}`;
                
                try {
                    // Try to load last week's chart data from history
                    const response = await fetch(prevWeekUrl + '?t=' + Date.now());
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`Loaded previous week chart data: ${prevWeekFileName}`);
                        return data;
                    } else {
                        console.log(`Previous week data not found: ${prevWeekFileName}`);
                    }
                } catch (err) {
                    console.log('Could not load previous week chart data:', err.message);
                }
                
                return null;
            }
            
            // Merge collaborative releases (same releaseId = same track, different artists)
            function deduplicateCollabs(releases) {
                const releaseMap = new Map();
                
                releases.forEach(release => {
                    const existing = releaseMap.get(release.releaseId);
                    if (existing) {
                        // Merge artist names for collab (avoid duplicates)
                        const existingArtists = existing.bandName.split(', ');
                        if (!existingArtists.includes(release.bandName)) {
                            existing.bandName = existingArtists.concat(release.bandName).join(', ');
                        }
                        // Keep the higher popularity and follower count
                        existing.popularity = Math.max(existing.popularity || 0, release.popularity || 0);
                        existing.followers = Math.max(existing.followers || 0, release.followers || 0);
                        // Mark as collab
                        existing.isCollab = true;
                    } else {
                        // Clone the release to avoid mutating the original
                        releaseMap.set(release.releaseId, { ...release });
                    }
                });
                
                return Array.from(releaseMap.values());
            }
            
            async function loadChartData() {
                let releases = [];
                let generatedAt = null;
                
                // Load previous data for comparison
                previousChartData = await loadPreviousData();
                
                // Load bands data for filtering
                try {
                    const bandsResponse = await fetch('bands.json?t=' + Date.now());
                    if (bandsResponse.ok) {
                        const bandsJson = await bandsResponse.json();
                        allBandsData = bandsJson.muzickaMasterLista || [];
                        console.log('Loaded', allBandsData.length, 'bands for filtering');
                    }
                } catch (err) {
                    console.warn('Could not load bands.json for filtering:', err);
                }
                
                try {
                    const response = await fetch(CHART_DATA_URL + '?t=' + Date.now());
                    if (response.ok) {
                        const chartData = await response.json();
                        releases = chartData.releases || [];
                        generatedAt = chartData.generatedAt;
                        console.log('Loaded', releases.length, 'releases from chart-data.json');
                        
                        // Previous week data is now managed by the generate script
                    } else {
                        console.warn('chart-data.json returned status:', response.status);
                    }
                } catch (err) {
                    console.warn('Could not load chart-data.json:', err);
                }
                
                if (releases.length === 0) {
                    console.warn('No releases found in chart-data.json');
                }
                
                // Deduplicate collaborative releases (same releaseId appearing for multiple artists)
                releases = deduplicateCollabs(releases);
                console.log('After deduplication:', releases.length, 'unique releases');
                
                // Store all releases for filtering
                allReleasesData = releases;
                
                updateDataInfo(generatedAt);
                document.querySelectorAll('.chart-loading').forEach(el => el.style.display = 'none');
                
                // Initialize filter buttons first
                initFilterButtons();
                
                // Apply current filters and render
                applyFilters();
                
                // Initialize scroll shadows after rendering
                initScrollShadows();
            }
            
            // Get artist's genre and city from bands.json
            function getArtistInfo(artistName) {
                if (!allBandsData || allBandsData.length === 0) return null;
                
                // Normalize artist name for matching
                const normalizedName = artistName.toLowerCase().trim();
                
                // Try exact match first
                let band = allBandsData.find(b => b.name.toLowerCase().trim() === normalizedName);
                
                // Try first artist in collab (split by comma)
                if (!band) {
                    const firstArtist = artistName.split(',')[0].trim().toLowerCase();
                    band = allBandsData.find(b => b.name.toLowerCase().trim() === firstArtist);
                }
                
                return band ? { genre: band.genre || '', city: band.city || '' } : null;
            }
            
            // Get artist info by artistId from bands.json
            function getArtistInfoById(artistId) {
                if (!allBandsData || allBandsData.length === 0) return null;
                
                const band = allBandsData.find(b => {
                    const idFromBand = b.links?.spotify?.match(/artist\/([a-zA-Z0-9]+)/)?.[1];
                    return idFromBand === artistId;
                });
                
                return band ? { name: band.name, genre: band.genre || '', city: band.city || '' } : null;
            }
            
            // Check if artist matches genre filter
            function artistMatchesGenre(artistName, genreFilter) {
                if (genreFilter === 'all') return true;
                
                const config = genreConfig[genreFilter];
                if (!config) return true;
                
                const artistInfo = getArtistInfo(artistName);
                if (!artistInfo) return false;
                
                const artistGenres = artistInfo.genre.toLowerCase();
                return config.genres.some(g => artistGenres.includes(g.toLowerCase()));
            }
            
            // Check if artist matches city filter
            function artistMatchesCity(artistName, cityFilter) {
                if (cityFilter === 'all') return true;
                
                const config = cityConfig[cityFilter];
                if (!config) return true;
                
                const artistInfo = getArtistInfo(artistName);
                if (!artistInfo) return false;
                
                const artistCity = artistInfo.city.toLowerCase();
                return artistCity.includes(config.city.toLowerCase());
            }
            
            // Check if artist matches genre filter by artistId
            function artistMatchesGenreById(artistId, genreFilter) {
                if (genreFilter === 'all') return true;
                
                const config = genreConfig[genreFilter];
                if (!config) return true;
                
                const artistInfo = getArtistInfoById(artistId);
                if (!artistInfo) return false;
                
                const artistGenres = artistInfo.genre.toLowerCase();
                return config.genres.some(g => artistGenres.includes(g.toLowerCase()));
            }
            
            // Check if artist matches city filter by artistId
            function artistMatchesCityById(artistId, cityFilter) {
                if (cityFilter === 'all') return true;
                
                const config = cityConfig[cityFilter];
                if (!config) return true;
                
                const artistInfo = getArtistInfoById(artistId);
                if (!artistInfo) return false;
                
                const artistCity = artistInfo.city.toLowerCase();
                return artistCity.includes(config.city.toLowerCase());
            }
            
            // Apply combined filters and re-render charts
            function applyFilters() {
                const { chart, genre, city } = currentFilters;
                
                // Filter releases based on genre AND city
                let filteredReleases = allReleasesData.filter(r => 
                    artistMatchesGenre(r.bandName, genre) && artistMatchesCity(r.bandName, city)
                );
                
                const sortByPopularity = (a, b) => (b.popularity || 0) - (a.popularity || 0);
                const singlesFilter = r => r.releaseType === 'single';
                const albumsFilter = r => r.releaseType === 'album' || r.releaseType === 'compilation';
                
                // Build filter label for display
                const genreLabel = genre !== 'all' ? genreConfig[genre]?.label : null;
                const cityLabel = city !== 'all' ? cityConfig[city]?.label : null;
                const filterSuffix = [genreLabel, cityLabel].filter(Boolean).join(' • ');
                
                if (chart === 'alltime') {
                    // All-time: Show single artists chart sorted by followers
                    document.getElementById('singles-section').style.display = 'none';
                    document.getElementById('albums-section').style.display = 'none';
                    document.getElementById('latest-section').style.display = 'none';
                    document.getElementById('artists-section').style.display = 'block';
                    
                    // Extract unique artists by artistId, apply genre/city filters
                    const artistMap = new Map();
                    for (const release of allReleasesData) {
                        // Skip if doesn't match genre/city filters
                        if (!artistMatchesGenreById(release.artistId, genre)) continue;
                        if (!artistMatchesCityById(release.artistId, city)) continue;
                        
                        const existing = artistMap.get(release.artistId);
                        if (!existing || (release.followers || 0) > (existing.followers || 0)) {
                            // Get canonical artist name from bands.json
                            const bandInfo = getArtistInfoById(release.artistId);
                            const canonicalName = bandInfo?.name || release.bandName;
                            
                            artistMap.set(release.artistId, {
                                artistId: release.artistId,
                                bandName: canonicalName,
                                followers: release.followers || 0,
                                spotifyUrl: release.spotifyUrl,
                                thumbnail: release.thumbnail
                            });
                        }
                    }
                    
                    // Sort by followers and take top 100
                    const topArtists = Array.from(artistMap.values())
                        .sort((a, b) => b.followers - a.followers)
                        .slice(0, 100);
                    
                    // Update period label with filter suffix
                    document.getElementById('artists-period').textContent = 'сите времиња' + (filterSuffix ? ' • ' + filterSuffix : '');
                    
                    renderArtistsChart('artists-chart', topArtists);
                    
                    // Store for sharing
                    chartDataStore.artists = topArtists;
                    chartDataStore.singles = [];
                    chartDataStore.albums = [];
                    chartDataStore.latest = [];
                    
                    console.log(`All-time artists (${filterSuffix || 'all'}): ${topArtists.length}`);
                } else {
                    // Standard view: Show release charts
                    document.getElementById('singles-section').style.display = 'block';
                    document.getElementById('albums-section').style.display = 'block';
                    document.getElementById('latest-section').style.display = 'block';
                    document.getElementById('artists-section').style.display = 'none';
                    
                    // Recent releases sorted by popularity
                    const releasesSortedByDate = [...filteredReleases].sort((a, b) => 
                        new Date(b.releaseDate).getTime() - new Date(a.releaseDate).getTime()
                    );
                    
                    const topSingles = releasesSortedByDate
                        .filter(singlesFilter)
                        .slice(0, 20)
                        .sort(sortByPopularity);
                    
                    const topAlbums = releasesSortedByDate
                        .filter(albumsFilter)
                        .slice(0, 20)
                        .sort(sortByPopularity);
                    
                    const latestReleases = releasesSortedByDate.slice(0, 20);
                    
                    // Set period labels with filter suffix
                    const periodWithFilter = periodText + (filterSuffix ? ' • ' + filterSuffix : '');
                    document.getElementById('singles-period').textContent = periodWithFilter;
                    document.getElementById('albums-period').textContent = periodWithFilter;
                    document.getElementById('latest-period').textContent = 'последни 20' + (filterSuffix ? ' • ' + filterSuffix : '');
                    
                    // Restore Latest section header
                    const latestHeader = document.querySelector('#latest-section h2');
                    if (latestHeader) {
                        latestHeader.innerHTML = '<i class="fas fa-clock"></i> Најнови';
                    }
                    
                    // Build previous chart maps for comparison
                    const prevReleases = previousChartData?.releases || [];
                    const prevSinglesMap = buildPreviousChartMap(prevReleases, singlesFilter, sortByPopularity, deduplicateCollabs);
                    const prevAlbumsMap = buildPreviousChartMap(prevReleases, albumsFilter, sortByPopularity, deduplicateCollabs);
                    
                    renderChart('singles-chart', topSingles, prevSinglesMap, false);
                    renderChart('albums-chart', topAlbums, prevAlbumsMap, false);
                    renderChart('latest-chart', latestReleases, {}, true);
                    
                    // Store chart data for sharing
                    chartDataStore.singles = topSingles;
                    chartDataStore.albums = topAlbums;
                    chartDataStore.latest = latestReleases;
                    chartDataStore.artists = [];
                    
                    console.log(`Filter applied (${filterSuffix || 'all'}): Singles: ${topSingles.length}, Albums: ${topAlbums.length}, Latest: ${latestReleases.length}`);
                }
            }
            
            // Initialize filter buttons (radio-button style per group)
            function initFilterButtons() {
                const filterBtns = document.querySelectorAll('.filter-btn[data-filter-type]');
                
                filterBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const filterType = btn.dataset.filterType;
                        const filterValue = btn.dataset.filterValue;
                        
                        // Update active state only within the same group
                        const group = btn.closest('.filter-group');
                        group.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        // Update filter state
                        currentFilters[filterType] = filterValue;
                        
                        // Apply combined filters
                        applyFilters();
                        
                        // Scroll charts into view on mobile
                        if (window.innerWidth <= 600) {
                            document.querySelector('.chart-container')?.scrollIntoView({ behavior: 'smooth' });
                        }
                    });
                });
                
                // Reset button
                const resetBtn = document.getElementById('reset-filters-btn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        // Reset filter state to defaults
                        currentFilters = {
                            chart: 'standard',
                            genre: 'all',
                            city: 'all'
                        };
                        
                        // Reset all button active states
                        document.querySelectorAll('.filter-group').forEach(group => {
                            group.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                            // Activate the first button (default) in each group
                            const firstBtn = group.querySelector('.filter-btn');
                            if (firstBtn) firstBtn.classList.add('active');
                        });
                        
                        // Apply filters
                        applyFilters();
                    });
                }
            }
            
            function renderChart(containerId, releases, previousMap = {}, isDateSorted = false) {
                const container = document.getElementById(containerId);
                const loading = document.getElementById(`${containerId}-loading`);
                const empty = document.getElementById(`${containerId}-empty`);
                
                loading.style.display = 'none';
                
                if (releases.length === 0) {
                    container.style.display = 'none';
                    empty.style.display = 'block';
                    // Update empty message based on current filters
                    const { genre, city } = currentFilters;
                    const genreLabel = genre !== 'all' ? genreConfig[genre]?.label : null;
                    const cityLabel = city !== 'all' ? cityConfig[city]?.label : null;
                    const filterLabel = [genreLabel, cityLabel].filter(Boolean).join(' + ');
                    
                    if (filterLabel) {
                        empty.innerHTML = `<p>Нема изданија за „${filterLabel}"</p>`;
                    } else {
                        // Default empty messages
                        if (containerId === 'singles-chart') empty.innerHTML = '<p>Нема синглови</p>';
                        else if (containerId === 'albums-chart') empty.innerHTML = '<p>Нема албуми</p>';
                        else empty.innerHTML = '<p>Нема изданија</p>';
                    }
                    return;
                }
                
                empty.style.display = 'none';
                container.style.display = 'block';
                container.innerHTML = releases.map((release, index) => {
                    const rank = index + 1;
                    const rankClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
                    let itemClass = rank <= 3 ? `rank-${rank}` : '';
                    
                    const popularity = release.popularity || 0;
                    
                    // Calculate time since release (smart formatting)
                    const releaseDate = new Date(release.releaseDate);
                    const now = new Date();
                    const msElapsed = now - releaseDate;
                    const hoursElapsed = Math.floor(msElapsed / (60 * 60 * 1000));
                    const daysElapsed = Math.floor(msElapsed / (24 * 60 * 60 * 1000));
                    const weeksElapsed = Math.floor(daysElapsed / 7);
                    
                    let timeSinceRelease, timeSinceTitle;
                    if (weeksElapsed >= 1) {
                        timeSinceRelease = `${weeksElapsed}н`;
                        timeSinceTitle = `${weeksElapsed} недел${weeksElapsed === 1 ? 'а' : 'и'} од издавање`;
                    } else if (daysElapsed >= 1) {
                        timeSinceRelease = `${daysElapsed}д`;
                        timeSinceTitle = `${daysElapsed} ден${daysElapsed === 1 ? '' : 'а'} од издавање`;
                    } else {
                        timeSinceRelease = `${Math.max(1, hoursElapsed)}ч`;
                        timeSinceTitle = `${Math.max(1, hoursElapsed)} час${hoursElapsed === 1 ? '' : 'а'} од издавање`;
                    }
                    
                    // Format release date for display
                    const monthNames = ['Јан', 'Фев', 'Мар', 'Апр', 'Мај', 'Јун', 'Јул', 'Авг', 'Сеп', 'Окт', 'Ное', 'Дек'];
                    const releaseDateStr = `${releaseDate.getDate()} ${monthNames[releaseDate.getMonth()]}`;
                    
                    // Get Spotify ID for embed
                    const spotifyMatch = (release.topTrackUrl || release.releaseUrl || '').match(/spotify\.com\/(track|album)\/([a-zA-Z0-9]+)/);
                    const spotifyType = spotifyMatch ? spotifyMatch[1] : null;
                    const spotifyId = spotifyMatch ? spotifyMatch[2] : null;
                    
                    // Check for changes from previous chart (skip for date-sorted)
                    let changeIndicator = '';
                    let popChangeIndicator = '';
                    
                    // Mark as new only if released within the last 7 days
                    if (daysElapsed <= 7) {
                        itemClass += ' is-new';
                    }
                    
                    if (!isDateSorted) {
                        const prev = previousMap[release.releaseId];
                        if (!prev) {
                            // New entry to the chart
                            changeIndicator = '';
                            popChangeIndicator = '';
                        } else {
                            // Position change
                            const posChange = prev.position - rank;
                            if (posChange > 0) {
                                changeIndicator = 'rank-up';
                            } else if (posChange < 0) {
                                changeIndicator = 'rank-down';
                            } else {
                                changeIndicator = 'rank-same';
                            }
                            
                            // Popularity change - only show if changed
                            const popDiff = popularity - prev.popularity;
                            if (popDiff > 0) {
                                popChangeIndicator = `<span class="pop-change up">+${popDiff}</span>`;
                            } else if (popDiff < 0) {
                                popChangeIndicator = `<span class="pop-change down">${popDiff}</span>`;
                            } else {
                                popChangeIndicator = '';
                            }
                        }
                    }
                    
                    // Time since release stat
                    const metaContent = `<span class="chart-stat weeks" title="${timeSinceTitle}">${timeSinceRelease}</span>`;
                    
                    // Show popularity score for releases (0-100)
                    const metricTitle = 'Популарност на Spotify (0-100)';
                    const metricDisplay = popularity;
                    
                    // For date-sorted charts, hide position and change indicators
                    const showPosition = !isDateSorted;
                    
                    return `
                        <li class="chart-item ${itemClass}">
                            ${showPosition ? `<span class="chart-rank ${rankClass} ${changeIndicator}" title="${changeIndicator === 'rank-up' ? 'Се качи' : changeIndicator === 'rank-down' ? 'Падна' : changeIndicator === 'rank-same' ? 'Без промена' : ''}">${rank}</span>` : ''}
                            <div class="chart-cover">
                                ${release.thumbnail 
                                    ? `<img src="${release.thumbnail}" alt="${release.releaseTitle}" loading="lazy" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'placeholder\\'><i class=\\'fab fa-spotify\\'></i></div>'">`
                                    : '<div class="placeholder"><i class="fab fa-spotify"></i></div>'
                                }
                            </div>
                            <div class="chart-info">
                                <div class="chart-title" ${spotifyId ? `data-spotify-id="${spotifyId}" data-spotify-type="${spotifyType}"` : `data-url="${release.topTrackUrl || release.releaseUrl}"`} title="Кликни за преслушување">${release.releaseTitle}</div>
                                <div class="chart-artist">${release.artistUrl 
                                    ? `<a href="${release.artistUrl}" target="_blank" class="chart-artist-link" title="Отвори артист во Spotify">${release.bandName}</a>`
                                    : release.bandName
                                }</div>
                            </div>
                            <div class="chart-meta">
                                ${metaContent}
                                <span class="chart-stat followers" title="${metricTitle}">${metricDisplay}${popChangeIndicator}</span>
                            </div>
                        </li>
                    `;
                }).join('');
                
                // Add click listeners for track titles to play
                container.querySelectorAll('.chart-title[data-spotify-id]').forEach(title => {
                    title.addEventListener('click', (e) => {
                        e.preventDefault();
                        const spotifyId = title.dataset.spotifyId;
                        const spotifyType = title.dataset.spotifyType;
                        const songTitle = title.textContent;
                        const item = title.closest('.chart-item');
                        const artist = item.querySelector('.chart-artist')?.textContent || '';
                        const thumbnail = item.querySelector('.chart-cover img')?.src || '';
                        showSpotifyEmbed(spotifyId, spotifyType, songTitle, artist, thumbnail);
                    });
                });
                
                // Fallback for titles without Spotify ID - open URL
                container.querySelectorAll('.chart-title[data-url]').forEach(title => {
                    title.addEventListener('click', (e) => {
                        e.preventDefault();
                        const url = title.dataset.url;
                        if (url) window.open(url, '_blank');
                    });
                });
            }
            
            // Render all-time artists chart
            function renderArtistsChart(containerId, artists) {
                const container = document.getElementById(containerId);
                const loading = document.getElementById(`${containerId}-loading`);
                const empty = document.getElementById(`${containerId}-empty`);
                
                loading.style.display = 'none';
                
                if (artists.length === 0) {
                    container.style.display = 'none';
                    empty.style.display = 'block';
                    return;
                }
                
                empty.style.display = 'none';
                container.style.display = 'block';
                container.innerHTML = artists.map((artist, index) => {
                    const rank = index + 1;
                    const rankClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
                    const itemClass = rank <= 3 ? `rank-${rank}` : '';
                    
                    const followers = artist.followers || 0;
                    const followersDisplay = followers >= 1000000 
                        ? (followers / 1000000).toFixed(1) + 'M'
                        : followers >= 1000 
                            ? (followers / 1000).toFixed(1) + 'K' 
                            : followers;
                    
                    // Get artist info from bands.json for genre/city
                    const artistInfo = getArtistInfo(artist.bandName);
                    const genre = artistInfo?.genre || '';
                    const city = artistInfo?.city || '';
                    
                    // Extract artist ID for Spotify link
                    const spotifyArtistUrl = artist.spotifyUrl || `https://open.spotify.com/artist/${artist.artistId}`;
                    
                    return `
                        <li class="chart-item artist-item ${itemClass}">
                            <span class="chart-rank ${rankClass}">${rank}</span>
                            <div class="chart-cover artist-cover">
                                ${artist.thumbnail 
                                    ? `<img src="${artist.thumbnail}" alt="${artist.bandName}" loading="lazy" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'placeholder\\'><i class=\\'fas fa-user\\'></i></div>'">`
                                    : '<div class="placeholder"><i class="fas fa-user"></i></div>'
                                }
                            </div>
                            <div class="chart-info">
                                <div class="chart-title artist-name">
                                    <a href="${spotifyArtistUrl}" target="_blank" title="Отвори во Spotify">${artist.bandName}</a>
                                </div>
                                <div class="chart-artist artist-details">${genre}${genre && city ? ' • ' : ''}${city}</div>
                            </div>
                            <div class="chart-meta">
                                <span class="chart-stat followers" title="${followers.toLocaleString()} следбеници на Spotify">
                                    <i class="fas fa-users"></i> ${followersDisplay}
                                </span>
                            </div>
                        </li>
                    `;
                }).join('');
            }
            
            // Inline music player functionality
            // Service definitions with icons and embed support
            const serviceDefinitions = {
                spotify: { name: 'Spotify', icon: 'fab fa-spotify', hasEmbed: true, linkKey: 'spotify' },
                youtube: { name: 'YouTube', icon: 'fab fa-youtube', hasEmbed: true, linkKey: 'youtube' },
                apple: { name: 'Apple', icon: 'fab fa-apple', hasEmbed: true, linkKey: 'apple' },
                deezer: { name: 'Deezer', icon: 'fab fa-deezer', hasEmbed: true, linkKey: 'deezer' },
                tidal: { name: 'Tidal', icon: 'fas fa-water', hasEmbed: false, linkKey: 'tidal' },
                bandcamp: { name: 'Bandcamp', icon: 'fab fa-bandcamp', hasEmbed: true, linkKey: 'bandcamp' },
                soundcloud: { name: 'SoundCloud', icon: 'fab fa-soundcloud', hasEmbed: true, linkKey: 'soundcloud' }
            };
            
            let bandsData = null;
            let currentTrackData = null;
            
            // Load bands.json on page load
            async function loadBandsData() {
                try {
                    const response = await fetch('bands.json?t=' + Date.now());
                    if (response.ok) {
                        const data = await response.json();
                        bandsData = data.muzickaMasterLista || [];
                        console.log('Loaded', bandsData.length, 'bands from bands.json');
                    }
                } catch (err) {
                    console.warn('Could not load bands.json:', err);
                    bandsData = [];
                }
            }
            
            // Find band by name (case-insensitive, handles collabs)
            function findBandByName(artistName) {
                if (!bandsData) return null;
                
                // Try exact match first
                let band = bandsData.find(b => b.name.toLowerCase() === artistName.toLowerCase());
                if (band) return band;
                
                // Try first artist in collab (split by comma)
                const firstArtist = artistName.split(',')[0].trim();
                band = bandsData.find(b => b.name.toLowerCase() === firstArtist.toLowerCase());
                if (band) return band;
                
                // Try partial match
                band = bandsData.find(b => artistName.toLowerCase().includes(b.name.toLowerCase()));
                return band;
            }
            
            function getPreferredService() {
                return localStorage.getItem('mmm-preferred-player') || 'spotify';
            }
            
            function setPreferredService(serviceId) {
                localStorage.setItem('mmm-preferred-player', serviceId);
            }
            
            function showMusicPlayer(spotifyId, type = 'track', title = '', artist = '', thumbnail = '') {
                let player = document.getElementById('music-player');
                
                // Find band links from bands.json
                const band = findBandByName(artist);
                const artistLinks = band?.links || {};
                
                currentTrackData = { spotifyId, type, title, artist, thumbnail, artistLinks };
                
                if (!player) {
                    // Create player if it doesn't exist
                    player = document.createElement('div');
                    player.id = 'music-player';
                    player.className = 'music-player';
                    player.innerHTML = `
                        <div class="music-player-bar">
                            <div class="music-player-cover">
                                <img src="" alt="">
                            </div>
                            <div class="music-player-info">
                                <div class="music-player-title"></div>
                                <div class="music-player-artist"></div>
                            </div>
                            <div class="music-player-tabs"></div>
                            <button class="music-player-close" title="Затвори"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="music-player-embed"></div>
                    `;
                    document.body.appendChild(player);
                    
                    // Close button
                    player.querySelector('.music-player-close').addEventListener('click', closeMusicPlayer);
                    
                    // Close on Escape
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && player.classList.contains('active')) {
                            closeMusicPlayer();
                        }
                    });
                }
                
                // Update player content - hide cover if no thumbnail
                const coverContainer = player.querySelector('.music-player-cover');
                const coverImg = coverContainer?.querySelector('img');
                if (thumbnail) {
                    if (coverImg) coverImg.src = thumbnail;
                    coverContainer.style.display = '';
                } else {
                    coverContainer.style.display = 'none';
                }
                player.querySelector('.music-player-title').textContent = title;
                player.querySelector('.music-player-artist').textContent = artist;
                
                // Render service tabs
                renderServiceTabs(player, artistLinks);
                
                // Load preferred service if available, or first available service
                const preferredService = getPreferredService();
                const hasPreferred = preferredService === 'spotify' || artistLinks[preferredService];
                
                if (hasPreferred) {
                    activateService(preferredService);
                } else if (artistLinks.spotify || spotifyId) {
                    activateService('spotify');
                } else {
                    // Load first available service
                    const firstAvailable = Object.keys(artistLinks)[0];
                    if (firstAvailable) {
                        activateService(firstAvailable);
                    }
                }
                
                player.classList.add('active');
            }
            
            function renderServiceTabs(player, artistLinks) {
                const tabsContainer = player.querySelector('.music-player-tabs');
                
                // Build available services
                const availableServices = [];
                
                // Spotify is always available if we have spotifyId
                if (currentTrackData.spotifyId) {
                    availableServices.push({ id: 'spotify', ...serviceDefinitions.spotify, url: null, hasEmbed: true });
                }
                
                // Add services from artist's links
                Object.entries(artistLinks).forEach(([key, url]) => {
                    if (key !== 'spotify' && serviceDefinitions[key]) {
                        availableServices.push({ id: key, ...serviceDefinitions[key], url });
                    }
                });
                
                if (availableServices.length === 0) {
                    tabsContainer.innerHTML = '';
                    return;
                }
                
                tabsContainer.innerHTML = availableServices.map(service => `
                    <button class="music-player-tab" 
                            data-service="${service.id}" 
                            data-url="${service.url || ''}"
                            data-has-embed="${service.hasEmbed}"
                            title="${service.name}">
                        <i class="${service.icon}"></i>
                    </button>
                `).join('');
                
                // Add click handlers
                tabsContainer.querySelectorAll('.music-player-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const serviceId = tab.dataset.service;
                        activateService(serviceId);
                        // Save preference
                        setPreferredService(serviceId);
                    });
                });
            }
            
            function activateService(serviceId) {
                const player = document.getElementById('music-player');
                if (!player || !currentTrackData) return;
                
                const tabsContainer = player.querySelector('.music-player-tabs');
                const embedContainer = player.querySelector('.music-player-embed');
                const { spotifyId, type, artistLinks } = currentTrackData;
                const service = serviceDefinitions[serviceId];
                const url = artistLinks[serviceId];
                
                // Update active tab
                tabsContainer.querySelectorAll('.music-player-tab').forEach(t => t.classList.remove('active'));
                const activeTab = tabsContainer.querySelector(`[data-service="${serviceId}"]`);
                if (activeTab) activeTab.classList.add('active');
                
                // Check if this service has an embed available
                let embedHtml = '';
                let hasEmbed = false;
                
                if (serviceId === 'spotify' && spotifyId) {
                    hasEmbed = true;
                    embedHtml = `<iframe src="https://open.spotify.com/embed/${type}/${spotifyId}?utm_source=generator&theme=0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>`;
                } else if (serviceId === 'youtube' && url) {
                    const ytMatch = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/|v\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
                    if (ytMatch) {
                        hasEmbed = true;
                        embedHtml = `<iframe class="youtube-embed" src="https://www.youtube.com/embed/${ytMatch[1]}?autoplay=0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>`;
                    }
                } else if (serviceId === 'soundcloud' && url) {
                    hasEmbed = true;
                    const encodedUrl = encodeURIComponent(url);
                    embedHtml = `<iframe class="soundcloud-embed" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=${encodedUrl}&color=%23ff5500&auto_play=false&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=false&visual=false" allow="autoplay" loading="lazy"></iframe>`;
                } else if (serviceId === 'apple' && url) {
                    const appleMatch = url.match(/music\.apple\.com\/([a-z]{2})\/(?:album|playlist)\/[^\/]+\/([0-9]+)/);
                    if (appleMatch) {
                        hasEmbed = true;
                        const country = appleMatch[1];
                        const albumId = appleMatch[2];
                        embedHtml = `<iframe class="apple-embed" src="https://embed.music.apple.com/${country}/album/${albumId}?theme=dark" allow="autoplay *; encrypted-media *; fullscreen *" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation" loading="lazy"></iframe>`;
                    }
                } else if (serviceId === 'deezer' && url) {
                    const deezerMatch = url.match(/deezer\.com\/(?:[a-z]{2}\/)?(track|album|artist)\/(\d+)/);
                    if (deezerMatch) {
                        hasEmbed = true;
                        const deezerType = deezerMatch[1];
                        const deezerId = deezerMatch[2];
                        embedHtml = `<iframe scrolling="no" frameborder="0" src="https://widget.deezer.com/widget/dark/${deezerType}/${deezerId}" style="width:100%;height:80px;" allow="encrypted-media; clipboard-write" loading="lazy"></iframe>`;
                    }
                }
                
                // If no embed available, open URL in new tab directly
                if (!hasEmbed && url) {
                    window.open(url, '_blank');
                    // Don't change the embed area, keep showing current service
                    return;
                }
                
                // Update embed
                if (hasEmbed) {
                    embedContainer.innerHTML = embedHtml;
                    embedContainer.classList.add('expanded');
                } else {
                    embedContainer.innerHTML = `<div class="music-player-no-embed">Нема достапен плеер за ${service?.name || 'оваа услуга'}</div>`;
                    embedContainer.classList.add('expanded');
                }
            }
            
            function closeMusicPlayer() {
                const player = document.getElementById('music-player');
                
                if (player) {
                    player.classList.remove('active');
                    // Stop playback by clearing embed
                    const embedContainer = player.querySelector('.music-player-embed');
                    if (embedContainer) {
                        embedContainer.innerHTML = '';
                        embedContainer.classList.remove('expanded');
                    }
                    currentTrackData = null;
                }
            }
            
            // Keep old function name for compatibility
            function showSpotifyEmbed(spotifyId, type = 'track', title = '', artist = '', thumbnail = '') {
                showMusicPlayer(spotifyId, type, title, artist, thumbnail);
            }
            
            function closeSpotifyEmbed() {
                closeMusicPlayer();
            }
            
            // Load bands data on page load
            loadBandsData();
            
            loadChartData();
            
            // ==================== DARK MODE ====================
            function initDarkMode() {
                const toggle = document.getElementById('dark-mode-toggle');
                if (!toggle) return;
                
                // Check localStorage for saved preference
                const savedMode = localStorage.getItem('mmm-dark-mode');
                if (savedMode === 'true') {
                    document.body.classList.add('dark-mode');
                    toggle.innerHTML = '<i class="fas fa-sun"></i>';
                }
                
                toggle.addEventListener('click', () => {
                    document.body.classList.toggle('dark-mode');
                    const isDark = document.body.classList.contains('dark-mode');
                    localStorage.setItem('mmm-dark-mode', isDark);
                    toggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                });
            }
            
            initDarkMode();
            
            // Initialize view modes after DOM is ready
            initViewModes();
            
            // ==================== TOUR FUNCTIONALITY ====================
            // Check if mobile
            const isMobile = () => window.innerWidth <= 600;
            
            const tourSteps = [
                {
                    element: null,
                    title: 'Македонска Музичка Топ Листа',
                    description: 'Преглед на најновите изданија од македонски артисти. Листите се ажурираат автоматски секој ден врз основа на Spotify податоци.',
                    position: 'center'
                },
                {
                    element: '.chart-filter-bar',
                    title: 'Специјални листи',
                    description: 'Изберете тип на листа: Стандардна, На сите времиња, или филтрирајте по жанр (Алтернативна, Рап/Трап, Електронска) и град (Скопје, Битола).',
                    position: 'bottom',
                    mobilePosition: 'bottom'
                },
                {
                    element: '#singles-section .chart-section-header',
                    title: 'Синглови',
                    description: 'Најпопуларни синглови од последните два месеци, рангирани според популарност на Spotify.',
                    position: 'bottom',
                    mobilePosition: 'bottom'
                },
                {
                    element: '#albums-section .chart-section-header',
                    title: 'Албуми',
                    description: 'Нови албуми и EP изданија од македонски артисти во истиот период.',
                    position: 'bottom',
                    mobilePosition: 'bottom'
                },
                {
                    element: '#latest-section .chart-section-header',
                    title: 'Најнови',
                    description: 'Последните 20 изданија подредени по датум на објава - од најново кон најстаро.',
                    position: 'bottom',
                    mobilePosition: 'bottom'
                },
                {
                    element: '.chart-item',
                    title: 'Детали за издание',
                    description: 'Секое издание содржи корица, наслов, артист и популарност. Стрелките покажуваат промена во позицијата од минатата недела.',
                    position: 'bottom',
                    mobilePosition: 'bottom'
                },
                {
                    element: '.view-mode-toggle',
                    title: 'Компактен приказ',
                    description: 'Менувајте помеѓу компактен и проширен приказ. На мобилни уреди стандардно е компактен.',
                    position: 'bottom',
                    mobilePosition: 'bottom'
                },
                {
                    element: 'a.header-btn[href="list.html"]',
                    title: 'База на артисти',
                    description: 'Пристап до комплетната база на македонски музички артисти со филтри и детални информации.',
                    position: 'bottom',
                    mobilePosition: 'bottom'
                }
            ];

            let currentTourStep = 0;
            let tourActive = false;

            function initTour() {
                const tourBtn = document.getElementById('start-tour-btn');
                if (!tourBtn) return;

                // Create tour overlay if not exists
                if (!document.getElementById('tour-overlay')) {
                    const overlay = document.createElement('div');
                    overlay.id = 'tour-overlay';
                    overlay.className = 'tour-overlay';
                    overlay.innerHTML = `
                        <div class="tour-highlight"></div>
                        <div class="tour-tooltip">
                            <div class="tour-tooltip-content">
                                <h3 class="tour-title"></h3>
                                <p class="tour-description"></p>
                            </div>
                            <div class="tour-footer">
                                <span class="tour-progress"></span>
                                <div class="tour-buttons">
                                    <button class="tour-btn-skip">Прескокни</button>
                                    <button class="tour-btn-prev"><i class="fas fa-arrow-left"></i></button>
                                    <button class="tour-btn-next">Следно <i class="fas fa-arrow-right"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(overlay);
                }

                const overlay = document.getElementById('tour-overlay');
                const tooltip = overlay.querySelector('.tour-tooltip');
                const prevBtn = tooltip.querySelector('.tour-btn-prev');
                const nextBtn = tooltip.querySelector('.tour-btn-next');
                const skipBtn = tooltip.querySelector('.tour-btn-skip');

                tourBtn.addEventListener('click', startTour);
                prevBtn.addEventListener('click', prevStep);
                nextBtn.addEventListener('click', nextStep);
                skipBtn.addEventListener('click', endTour);

                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay || e.target.classList.contains('tour-highlight')) {
                        endTour();
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (!tourActive) return;
                    if (e.key === 'Escape') endTour();
                    if (e.key === 'ArrowRight' || e.key === 'Enter') nextStep();
                    if (e.key === 'ArrowLeft') prevStep();
                });
            }

            function startTour() {
                tourActive = true;
                currentTourStep = 0;
                document.getElementById('tour-overlay').classList.add('active');
                // On mobile, allow scrolling to see elements; on desktop, prevent scroll
                if (!isMobile()) {
                    document.body.style.overflow = 'hidden';
                }
                showTourStep(currentTourStep);
            }

            function endTour() {
                tourActive = false;
                document.getElementById('tour-overlay').classList.remove('active');
                document.body.style.overflow = '';
            }

            function prevStep() {
                if (currentTourStep > 0) {
                    currentTourStep--;
                    showTourStep(currentTourStep);
                }
            }

            function nextStep() {
                if (currentTourStep < tourSteps.length - 1) {
                    currentTourStep++;
                    showTourStep(currentTourStep);
                } else {
                    endTour();
                }
            }

            function showTourStep(stepIndex) {
                const step = tourSteps[stepIndex];
                const overlay = document.getElementById('tour-overlay');
                const highlight = overlay.querySelector('.tour-highlight');
                const tooltip = overlay.querySelector('.tour-tooltip');
                const titleEl = tooltip.querySelector('.tour-title');
                const descEl = tooltip.querySelector('.tour-description');
                const progressEl = tooltip.querySelector('.tour-progress');
                const prevBtn = tooltip.querySelector('.tour-btn-prev');
                const nextBtn = tooltip.querySelector('.tour-btn-next');

                titleEl.textContent = step.title;
                descEl.innerHTML = step.description;
                progressEl.textContent = `${stepIndex + 1} / ${tourSteps.length}`;

                prevBtn.disabled = stepIndex === 0;
                nextBtn.innerHTML = stepIndex === tourSteps.length - 1 
                    ? 'Заврши <i class="fas fa-check"></i>' 
                    : 'Следно <i class="fas fa-arrow-right"></i>';

                tooltip.classList.remove('arrow-top', 'arrow-bottom', 'arrow-left', 'arrow-right', 'tour-center');

                // On mobile, use bottom sheet style - hide highlight and let CSS handle tooltip
                if (isMobile()) {
                    highlight.style.display = 'none';
                    tooltip.style.top = '';
                    tooltip.style.left = '';
                    
                    // Scroll target element into view if it exists
                    const targetEl = step.element ? document.querySelector(step.element) : null;
                    if (targetEl) {
                        targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    return;
                }

                if (step.position === 'center' || !step.element) {
                    highlight.style.display = 'none';
                    tooltip.classList.add('tour-center');
                    tooltip.style.top = '';
                    tooltip.style.left = '';
                } else {
                    const targetEl = document.querySelector(step.element);
                    if (!targetEl) {
                        if (stepIndex < tourSteps.length - 1) {
                            currentTourStep++;
                            showTourStep(currentTourStep);
                        }
                        return;
                    }

                    setTimeout(() => {
                        positionHighlight(targetEl, highlight);
                        positionTooltip(targetEl, tooltip, step.position);
                    }, 50);
                }
            }

            function positionHighlight(element, highlight) {
                const rect = element.getBoundingClientRect();
                const padding = 4;
                highlight.style.display = 'block';
                highlight.style.top = (rect.top - padding) + 'px';
                highlight.style.left = (rect.left - padding) + 'px';
                highlight.style.width = (rect.width + padding * 2) + 'px';
                highlight.style.height = (rect.height + padding * 2) + 'px';
            }

            function positionTooltip(element, tooltip, position) {
                const rect = element.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();
                const gap = 16;
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;

                if (viewportWidth <= 600) {
                    tooltip.classList.add('arrow-top');
                    return;
                }

                let top, left;
                let arrowClass = '';

                switch (position) {
                    case 'bottom':
                        top = rect.bottom + gap;
                        left = rect.left + rect.width / 2 - tooltipRect.width / 2;
                        arrowClass = 'arrow-top';
                        break;
                    case 'top':
                        top = rect.top - tooltipRect.height - gap;
                        left = rect.left + rect.width / 2 - tooltipRect.width / 2;
                        arrowClass = 'arrow-bottom';
                        break;
                    case 'left':
                        top = rect.top + rect.height / 2 - tooltipRect.height / 2;
                        left = rect.left - tooltipRect.width - gap;
                        arrowClass = 'arrow-right';
                        break;
                    case 'right':
                        top = rect.top + rect.height / 2 - tooltipRect.height / 2;
                        left = rect.right + gap;
                        arrowClass = 'arrow-left';
                        break;
                }

                if (left < 10) left = 10;
                if (left + tooltipRect.width > viewportWidth - 10) left = viewportWidth - tooltipRect.width - 10;
                if (top < 10) top = 10;
                if (top + tooltipRect.height > viewportHeight - 10) top = viewportHeight - tooltipRect.height - 10;

                tooltip.style.top = top + 'px';
                tooltip.style.left = left + 'px';
                tooltip.classList.add(arrowClass);
            }

            initTour();
        });
    </script>
</body>
</html>
