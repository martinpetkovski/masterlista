<!DOCTYPE html>
<html lang="mk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Македонска Музичка Топ Листа | Најпопуларни Македонски Песни</title>
    
    <!-- Primary SEO Meta Tags -->
    <meta name="title" content="Македонска Музичка Топ Листа | Најпопуларни Македонски Песни">
    <meta name="description" content="Откријте ги најпопуларните македонски песни и албуми. Топ листа на сингли, албуми и нови изданија од македонската музичка сцена. Ажурирано неделно.">
    <meta name="keywords" content="македонска музика, топ листа, македонски песни, македонски албуми, музичка листа, македонски артисти, нови изданија, македонска музичка сцена">
    <meta name="author" content="Македонска Музичка Мастер Листа">
    <meta name="robots" content="index, follow">
    <meta name="language" content="Macedonian">
    <meta name="revisit-after" content="7 days">
    <link rel="canonical" href="https://toplista.mk/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://toplista.mk/">
    <meta property="og:title" content="Македонска Музичка Топ Листа | Најпопуларни Македонски Песни">
    <meta property="og:description" content="Откријте ги најпопуларните македонски песни и албуми. Топ листа на сингли, албуми и нови изданија од македонската музичка сцена.">
    <meta property="og:image" content="https://toplista.mk/og-image.png">
    <meta property="og:locale" content="mk_MK">
    <meta property="og:site_name" content="Топ Листа МК">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://toplista.mk/">
    <meta property="twitter:title" content="Македонска Музичка Топ Листа">
    <meta property="twitter:description" content="Откријте ги најпопуларните македонски песни и албуми. Топ листа од македонската музичка сцена.">
    <meta property="twitter:image" content="https://toplista.mk/og-image.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    <!-- Structured Data / JSON-LD -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "Македонска Музичка Топ Листа",
        "alternateName": "Топ Листа МК",
        "url": "https://toplista.mk/",
        "description": "Топ листа на најпопуларни македонски песни, албуми и нови изданија",
        "inLanguage": "mk",
        "publisher": {
            "@type": "Organization",
            "name": "Македонска Музичка Мастер Листа"
        }
    }
    </script>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "ItemList",
        "name": "Македонска Музичка Топ Листа",
        "description": "Неделна листа на најпопуларни македонски сингли и албуми",
        "itemListElement": []
    }
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600&family=Montserrat:wght@600;700&family=Bungee&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="desktop.css" media="screen and (min-width: 601px)">
    <link rel="stylesheet" href="mobile.css" media="screen and (max-width: 600px)">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Dark mode variables */
        body.dark-mode {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-hover: #252542;
            --text-primary: #f0f0f5;
            --text-secondary: #b8b8cc;
            --text-muted: #6e6e8a;
            --border-color: #3d3d5c;
            --accent-blue: #5c7cfa;
            --accent-green: #51cf66;
            --accent-orange: #ff922b;
            --accent-red: #ff6b6b;
            --accent-purple: #9775fa;
            --accent-teal: #20c997;
        }
        
        body.dark-mode .chart-section-header {
            background: linear-gradient(135deg, #c9302c, #d9534f);
        }
        
        body.dark-mode .share-card {
            background: #0f0f1a;
            border-color: #3d3d5c;
        }
        
        body.dark-mode .share-card-list {
            background: #0f0f1a;
        }
        
        body.dark-mode .share-card-item {
            border-color: #3d3d5c;
        }
        
        body.dark-mode .share-card-song {
            color: #f0f0f5;
        }
        
        body.dark-mode .share-card-artist {
            color: #b8b8cc;
        }
        
        body.dark-mode .share-card-footer {
            background: #1a1a2e;
            border-color: #2d3a5a;
        }
        
        /* Dark mode for chart sections and items */
        body.dark-mode .chart-section {
            background: linear-gradient(180deg, rgba(26, 26, 46, 0.95) 0%, rgba(22, 33, 62, 0.9) 100%);
            border-color: #2d3a5a;
        }
        
        body.dark-mode .chart-item {
            background: linear-gradient(90deg, rgba(45, 58, 90, 0.3) 0%, transparent 100%);
            border-color: #2d3a5a;
        }
        
        body.dark-mode .chart-item:hover {
            background: linear-gradient(90deg, rgba(45, 58, 90, 0.6) 0%, rgba(45, 58, 90, 0.2) 100%);
        }
        
        body.dark-mode .chart-cover {
            background: #2d3a5a;
        }
        
        body.dark-mode .chart-title {
            color: #eee;
        }
        
        body.dark-mode .chart-artist-link {
            color: #aaa;
        }
        
        body.dark-mode .chart-release-type {
            background: rgba(45, 58, 90, 0.6);
            color: #aaa;
        }
        
        body.dark-mode .share-modal-content {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            border-color: #2d3a5a;
        }
        
        body.dark-mode .share-actions button {
            background: linear-gradient(180deg, #2d3a5a 0%, #252e45 100%);
            border-color: #3d4a6a;
            color: #eee;
        }
        
        body.dark-mode .share-actions button:hover {
            background: linear-gradient(180deg, #3d4a6a 0%, #2d3a5a 100%);
        }
        
        body.dark-mode .share-modal-close {
            color: #aaa;
        }
        
        body.dark-mode .share-modal-close:hover {
            color: #eee;
        }
        
        body.dark-mode .cache-info {
            color: #777;
        }
        
        /* Chart page icon-only buttons */
        .chart-page .header-btn {
            font-size: 0;
            width: 34px;
            height: 34px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            position: relative;
        }
        
        .chart-page .header-btn i {
            font-size: 0.9rem;
        }
        
        /* Tooltip for buttons on chart page */
        .chart-page .header-btn[title]::after {
            content: attr(title);
            position: absolute;
            top: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            padding: 0.35rem 0.6rem;
            background: linear-gradient(180deg, #343a40 0%, #212529 100%);
            color: #fff;
            font-size: 0.7rem;
            font-weight: 600;
            white-space: nowrap;
            border-radius: 6px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            pointer-events: none;
        }
        
        .chart-page .header-btn[title]::before {
            content: '';
            position: absolute;
            top: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: #343a40;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s ease;
            z-index: 1000;
        }
        
        .chart-page .header-btn[title]:hover::after,
        .chart-page .header-btn[title]:hover::before {
            opacity: 1;
            visibility: visible;
        }
        
        .chart-page .header-btn:hover {
            transform: translateY(-1px);
        }
        
        /* Dark mode toggle button */
        .dark-mode-toggle {
            background: linear-gradient(180deg, var(--bg-primary) 0%, rgba(0,0,0,0.05) 100%);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            width: 34px;
            height: 34px;
            padding: 0;
            font-size: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        
        .dark-mode-toggle i {
            font-size: 0.9rem;
        }
        
        .dark-mode-toggle:hover {
            background: linear-gradient(180deg, var(--bg-hover) 0%, rgba(0,0,0,0.08) 100%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.8);
            transform: translateY(-1px);
        }
        
        body.dark-mode .dark-mode-toggle {
            background: linear-gradient(180deg, #2d3a5a 0%, #252e45 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
        }
        
        body.dark-mode .dark-mode-toggle:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.15);
        }
        
        body.chart-page {
            overflow: hidden;
            height: 100vh;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: 
                radial-gradient(ellipse at 0% 0%, rgba(103, 126, 234, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 100% 0%, rgba(250, 82, 82, 0.06) 0%, transparent 40%),
                radial-gradient(ellipse at 100% 100%, rgba(18, 184, 134, 0.07) 0%, transparent 50%),
                radial-gradient(ellipse at 0% 100%, rgba(121, 80, 242, 0.06) 0%, transparent 45%),
                radial-gradient(ellipse at 50% 50%, rgba(253, 126, 20, 0.04) 0%, transparent 60%),
                linear-gradient(180deg, #f8fafc 0%, #eef2f7 25%, #e8ecf2 50%, #e2e8ef 75%, #dce3eb 100%);
        }
        
        body.dark-mode.chart-page {
            background: 
                radial-gradient(ellipse at 0% 0%, rgba(103, 126, 234, 0.12) 0%, transparent 45%),
                radial-gradient(ellipse at 100% 0%, rgba(250, 82, 82, 0.08) 0%, transparent 40%),
                radial-gradient(ellipse at 100% 100%, rgba(18, 184, 134, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 0% 100%, rgba(121, 80, 242, 0.1) 0%, transparent 45%),
                radial-gradient(ellipse at 50% 50%, rgba(253, 126, 20, 0.06) 0%, transparent 55%),
                linear-gradient(180deg, #1a1a2e 0%, #151a30 20%, #121929 40%, #0f172a 60%, #0c1322 80%, #0a101c 100%);
        }
        
        .chart-container {
            max-width: 100%;
            padding: 0.85rem 1.25rem;
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }
        
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.65rem;
            padding: 0 0.35rem;
        }
        
        .chart-header h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .chart-header h1 i { color: var(--accent-orange); font-size: 0.8rem; }
        
        .chart-header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .cache-info {
            font-size: 0.65rem;
            color: var(--text-muted);
        }
        
        .chart-sections {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            flex: 1;
            min-height: 0;
        }
        
        .chart-section {
            background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(248,249,250,0.9) 100%);
            border: 1px solid rgba(222, 226, 230, 0.6);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06),
                        inset 0 1px 0 rgba(255,255,255,0.9);
            transition: all 0.2s ease;
        }
        
        .chart-section:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05),
                        inset 0 1px 0 rgba(255,255,255,0.9);
        }
        
        .chart-section-header {
            background: linear-gradient(135deg, #fa5252 0%, #fd7e14 100%);
            color: #fff;
            padding: 0.6rem 0.85rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.25), 
                        inset 0 -1px 0 rgba(0,0,0,0.15),
                        0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .chart-section-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, rgba(0,0,0,0.1) 0%, transparent 50%, rgba(0,0,0,0.1) 100%);
        }
        
        .chart-section-header h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.35rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .chart-section-header h2 i { font-size: 0.75rem; }
        
        .chart-section-header .period {
            font-size: 0.65rem;
            opacity: 0.9;
            font-weight: 500;
        }
        
        .chart-header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .share-btn {
            background: linear-gradient(180deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.1) 100%);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: #fff;
            padding: 0.25rem 0.5rem;
            font-size: 0.55rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.2rem;
            transition: all 0.15s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        
        .share-btn:hover {
            background: linear-gradient(180deg, rgba(255,255,255,0.35) 0%, rgba(255,255,255,0.2) 100%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.3);
        }
        
        .share-btn:active {
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .share-btn i {
            font-size: 0.5rem;
        }
        
        .share-btn.sharing {
            pointer-events: none;
            opacity: 0.7;
        }
        
        /* Share modal/preview */
        .share-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
        }
        
        .share-modal.active {
            display: flex;
        }
        
        .share-modal-content {
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            border-radius: 10px;
            max-width: 420px;
            max-height: 85vh;
            overflow: auto;
            position: relative;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.4), 
                        0 0 0 1px rgba(255,255,255,0.1),
                        inset 0 1px 0 rgba(255,255,255,0.2);
            backdrop-filter: blur(20px);
        }
        
        .share-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.6rem 0.85rem;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, transparent 100%);
        }
        
        .share-modal-header h3 {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8rem;
            font-weight: 700;
        }
        
        .share-modal-close {
            background: linear-gradient(180deg, rgba(0,0,0,0.05) 0%, rgba(0,0,0,0.1) 100%);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            padding: 0.25rem 0.4rem;
            transition: all 0.15s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .share-modal-close:hover {
            color: var(--text-primary);
            background: linear-gradient(180deg, rgba(0,0,0,0.08) 0%, rgba(0,0,0,0.15) 100%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .share-preview {
            padding: 0.75rem;
            display: flex;
            justify-content: center;
            background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.02) 100%);
        }
        
        .share-preview img {
            max-width: 100%;
            max-height: 350px;
            border-radius: 6px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3), 0 3px 8px rgba(0,0,0,0.15);
        }
        
        .share-actions {
            display: flex;
            gap: 0.5rem;
            padding: 0.6rem 0.85rem;
            border-top: 1px solid var(--border-color);
            justify-content: center;
            flex-wrap: wrap;
            background: linear-gradient(180deg, rgba(0,0,0,0.02) 0%, rgba(0,0,0,0.05) 100%);
        }
        
        .share-action-btn {
            background: linear-gradient(180deg, var(--accent-green) 0%, #37b24d 100%);
            border: none;
            border-radius: 6px;
            color: #fff;
            padding: 0.45rem 0.9rem;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: all 0.15s ease;
            box-shadow: 0 3px 5px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        
        .share-action-btn:hover {
            box-shadow: 0 5px 8px rgba(0,0,0,0.18), inset 0 1px 0 rgba(255,255,255,0.25);
        }
        
        .share-action-btn:active {
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .share-action-btn.download {
            background: linear-gradient(180deg, var(--accent-blue) 0%, #1864ab 100%);
        }
        
        .share-action-btn.copy {
            background: linear-gradient(180deg, var(--accent-purple) 0%, #7048e8 100%);
        }
        
        /* Shareable chart card (hidden, used for rendering) */
        .share-card {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 420px;
            background: #fff;
            padding: 0;
            border-radius: 8px;
            font-family: 'Source Sans Pro', sans-serif;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        
        .share-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #fa5252, #fd7e14);
        }
        
        .share-card-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .share-card-title i {
            font-size: 0.9rem;
        }
        
        .share-card-branding {
            font-size: 0.55rem;
            color: rgba(255,255,255,0.85);
            text-align: right;
            line-height: 1.3;
        }
        
        .share-card-branding .mmm {
            font-family: 'Bungee', sans-serif;
            font-size: 0.8rem;
            background: linear-gradient(135deg, #fa5252, #fd7e14);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: #fff;
            display: block;
            margin-bottom: 2px;
        }
        
        .share-card-list {
            list-style: none;
            padding: 0.5rem 0;
            margin: 0;
            background: #fff;
        }
        
        .share-card-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            gap: 0.6rem;
            border-bottom: 1px solid #eee;
        }
        
        .share-card-item:last-child {
            border-bottom: none;
        }
        
        .share-card-item:nth-child(1) {
            background: linear-gradient(90deg, rgba(255,215,0,0.15) 0%, transparent 100%);
        }
        
        .share-card-item:nth-child(2) {
            background: linear-gradient(90deg, rgba(192,192,192,0.12) 0%, transparent 100%);
        }
        
        .share-card-item:nth-child(3) {
            background: linear-gradient(90deg, rgba(205,127,50,0.12) 0%, transparent 100%);
        }
        
        .share-card-rank {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            width: 24px;
            text-align: right;
            color: #999;
        }
        
        .share-card-rank.gold { color: #d4a000; }
        .share-card-rank.silver { color: #888; }
        .share-card-rank.bronze { color: #a06020; }
        
        .share-card-cover {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
            background: #f0f0f0;
        }
        
        .share-card-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .share-card-info {
            flex: 1;
            min-width: 0;
        }
        
        .share-card-song {
            font-weight: 600;
            font-size: 0.9rem;
            color: #1a1a1a;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .share-card-artist {
            font-size: 0.75rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .share-card-footer {
            padding: 0.6rem 1rem;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top: 1px solid #eee;
        }
        
        .share-card-date {
            font-size: 0.65rem;
            color: #888;
        }
        
        .share-card-url {
            font-size: 0.6rem;
            color: #aaa;
        }
        
        .chart-list-wrapper {
            position: relative;
            flex: 1;
            min-height: 0;
        }
        
        .chart-list-wrapper::before,
        .chart-list-wrapper::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 20px;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .chart-list-wrapper::before {
            top: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, transparent 100%);
        }
        
        .chart-list-wrapper::after {
            bottom: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.3) 0%, transparent 100%);
        }
        
        .chart-list-wrapper.scroll-top::before { opacity: 1; }
        .chart-list-wrapper.scroll-bottom::after { opacity: 1; }
        
        .chart-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: none;
            height: 100%;
            overflow-y: auto;
        }
        
        .chart-list::-webkit-scrollbar { width: 4px; }
        .chart-list::-webkit-scrollbar-track { background: var(--bg-secondary); }
        .chart-list::-webkit-scrollbar-thumb { background: var(--border-color); }
        
        .chart-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.85rem 0.5rem 0.5rem;
            border-bottom: 1px solid var(--border-color);
            gap: 0.45rem;
            transition: all 0.15s ease;
            background: linear-gradient(90deg, rgba(255,255,255,0.5) 0%, transparent 100%);
        }
        
        .chart-item:last-child { border-bottom: none; }
        .chart-item:hover { 
            background: linear-gradient(90deg, var(--bg-hover) 0%, rgba(255,255,255,0.3) 100%);
            box-shadow: inset 3px 0 0 var(--accent-orange);
        }
        
        .chart-rank {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 800;
            width: 22px;
            text-align: right;
            flex-shrink: 0;
            color: var(--text-muted);
        }
        
        .chart-rank.gold { 
            color: #d4a000; 
        }
        .chart-rank.silver { 
            color: #8a8a8a; 
        }
        .chart-rank.bronze { 
            color: #a86830; 
        }
        
        .chart-item.rank-1 { background: linear-gradient(90deg, rgba(255,215,0,0.12) 0%, rgba(255,215,0,0.03) 60%, transparent 100%); }
        .chart-item.rank-2 { background: linear-gradient(90deg, rgba(192,192,192,0.12) 0%, rgba(192,192,192,0.03) 60%, transparent 100%); }
        .chart-item.rank-3 { background: linear-gradient(90deg, rgba(205,127,50,0.12) 0%, rgba(205,127,50,0.03) 60%, transparent 100%); }
        
        .chart-cover {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
            background: var(--bg-secondary);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15), 0 1px 2px rgba(0,0,0,0.1);
            transition: all 0.15s ease;
        }
        
        .chart-item:hover .chart-cover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.15);
        }
        
        .chart-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .chart-cover .placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1DB954, #191414);
            color: rgba(255,255,255,0.5);
            font-size: 0.7rem;
        }
        
        .chart-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }
        
        .chart-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .chart-title:hover {
            color: #1DB954;
        }
        
        .chart-artist {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chart-artist-link {
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.15s ease;
        }
        
        .chart-artist-link:hover {
            color: #1DB954;
            text-decoration: none;
            background: linear-gradient(90deg, rgba(29,185,84,0.1) 0%, transparent 100%);
            padding-left: 0.25rem;
            margin-left: -0.25rem;
            border-radius: 3px;
        }
        
        .chart-release-type {
            display: inline-block;
            font-size: 0.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-green) 0%, #37b24d 100%);
            color: #fff;
            padding: 0.08rem 0.25rem;
            border-radius: 3px;
            margin-left: 0.2rem;
            vertical-align: middle;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
        }
        
        .chart-release-type.album { 
            background: linear-gradient(135deg, var(--accent-purple) 0%, #7048e8 100%); 
        }
        .chart-release-type.ep { 
            background: linear-gradient(135deg, var(--accent-blue) 0%, #1864ab 100%); 
        }
        
        /* Chart change indicators */
        .chart-change {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            flex-shrink: 0;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .chart-change.new {
            color: #d4a000;
        }
        
        .chart-change.new i {
            font-size: 0.85rem;
        }
        
        .chart-change.up {
            color: #1DB954;
        }
        
        .chart-change.down {
            color: #e74c3c;
        }
        
        .chart-change.same {
            color: var(--text-muted);
            font-size: 0.6rem;
        }
        
        .chart-change .change-value {
            font-size: 0.65rem;
            margin-left: 2px;
        }
        
        /* Popularity change indicator - superscript style */
        .pop-change {
            font-size: 0.45rem;
            font-weight: 700;
            position: absolute;
            top: -4px;
            right: -2px;
            transform: translateX(100%);
        }
        
        .pop-change.up { color: #1DB954; }
        .pop-change.down { color: #e74c3c; }
        
        /* New entry highlight */
        .chart-item.is-new {
            background: linear-gradient(90deg, rgba(255,215,0,0.1) 0%, rgba(255,215,0,0.02) 50%, transparent 100%);
        }
        
        .chart-item.is-new .chart-title::after {
            content: 'НОВО';
            font-size: 0.45rem;
            font-weight: 700;
            background: linear-gradient(135deg, #d4a000, #c47f00);
            color: #fff;
            padding: 0.1rem 0.25rem;
            border-radius: 3px;
            margin-left: 0.35rem;
            vertical-align: middle;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .chart-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        .chart-stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
        }
        
        .chart-stat.weeks {
            width: 32px;
            justify-content: flex-end;
            white-space: nowrap;
            background: linear-gradient(135deg, rgba(0,0,0,0.03) 0%, transparent 100%);
            padding: 0.15rem 0.25rem;
            border-radius: 4px;
        }
        
        .chart-stat.followers {
            width: 32px;
            margin-right: 10px;
            justify-content: flex-end;
            color: var(--accent-green);
            position: relative;
            font-weight: 600;
        }
        
        .chart-stat i { font-size: 0.7rem; }
        

        
        .chart-loading, .chart-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.75rem;
            background: linear-gradient(180deg, rgba(0,0,0,0.02) 0%, rgba(0,0,0,0.05) 100%);
            border-radius: 8px;
            margin: 0.5rem;
        }
        
        .chart-loading i, .chart-empty i {
            font-size: 1.25rem;
            color: var(--accent-blue);
            margin-bottom: 0.75rem;
            display: block;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.65rem;
            padding: 0.35rem 0.6rem;
            border-radius: 6px;
            transition: all 0.15s ease;
            background: linear-gradient(180deg, rgba(0,0,0,0.02) 0%, rgba(0,0,0,0.05) 100%);
        }
        
        .back-link:hover { 
            color: var(--accent-blue); 
            background: linear-gradient(180deg, rgba(34,139,230,0.08) 0%, rgba(34,139,230,0.15) 100%);
        }
        
        /* Mobile adjustments */
        @media (max-width: 900px) {
            .chart-sections { grid-template-columns: 1fr; }
            .chart-list { max-height: none; }
        }
        
        @media (max-width: 600px) {
            .chart-container { 
                padding: 0.5rem; 
                padding-bottom: calc(0.5rem + env(safe-area-inset-bottom, 0px));
            }
            .chart-header h1 { font-size: 0.8rem; }
            .chart-item { padding: 0.2rem 0.35rem; }
            .chart-cover { width: 24px; height: 24px; }
            
            /* Mobile header buttons - more compact */
            .chart-section-header {
                padding: 0.5rem 0.65rem;
            }
            .chart-section-header h2 {
                font-size: 0.75rem;
            }
            .chart-header-right {
                gap: 0.35rem;
            }
            .chart-section-header .period {
                font-size: 0.55rem;
            }
            .share-btn {
                padding: 0.2rem 0.35rem;
                font-size: 0.5rem;
            }
            .share-btn span {
                display: none;
            }
            .view-mode-toggle {
                padding: 0.2rem 0.35rem;
            }
        }
        
        /* Compact/Expanded mode toggle */
        .view-mode-toggle {
            background: linear-gradient(180deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.1) 100%);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: #fff;
            padding: 0.25rem 0.4rem;
            font-size: 0.6rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.2rem;
            transition: all 0.15s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        
        .view-mode-toggle:hover {
            background: linear-gradient(180deg, rgba(255,255,255,0.35) 0%, rgba(255,255,255,0.2) 100%);
        }
        
        .view-mode-toggle i { font-size: 0.55rem; }
        
        /* Compact mode styles - single row layout */
        .chart-section.compact-mode .chart-item {
            padding: 0.2rem 0.5rem;
            gap: 0.35rem;
        }
        
        .chart-section.compact-mode .chart-cover {
            width: 28px;
            height: 28px;
            border-radius: 3px;
        }
        
        .chart-section.compact-mode .chart-rank {
            font-size: 0.7rem;
            width: 16px;
        }
        
        .chart-section.compact-mode .chart-change {
            width: 18px;
            font-size: 0.6rem;
        }
        
        /* Single row: title and artist inline */
        .chart-section.compact-mode .chart-info {
            flex-direction: row;
            align-items: center;
            gap: 0.35rem;
        }
        
        .chart-section.compact-mode .chart-title {
            font-size: 0.75rem;
            flex-shrink: 1;
        }
        
        .chart-section.compact-mode .chart-artist {
            font-size: 0.7rem;
            flex-shrink: 2;
            opacity: 0.7;
        }
        
        .chart-section.compact-mode .chart-artist::before {
            content: '•';
            margin-right: 0.35rem;
            opacity: 0.5;
        }
        
        .chart-section.compact-mode .chart-meta {
            gap: 0.3rem;
        }
        
        .chart-section.compact-mode .chart-stat {
            font-size: 0.65rem;
        }
        
        .chart-section.compact-mode .chart-stat.weeks {
            width: 26px;
            padding: 0.1rem 0.2rem;
        }
        
        .chart-section.compact-mode .chart-stat.followers {
            width: 26px;
            margin-right: 6px;
        }
        
        /* Mobile compact - even more compact, single row */
        @media (max-width: 600px) {
            .chart-section.compact-mode .chart-item {
                padding: 0.15rem 0.35rem;
                gap: 0.2rem;
            }
            
            .chart-section.compact-mode .chart-cover {
                width: 24px;
                height: 24px;
            }
            
            .chart-section.compact-mode .chart-rank {
                font-size: 0.65rem;
                width: 14px;
            }
            
            .chart-section.compact-mode .chart-change {
                width: 16px;
                font-size: 0.55rem;
            }
            
            .chart-section.compact-mode .chart-info {
                gap: 0.25rem;
            }
            
            .chart-section.compact-mode .chart-title {
                font-size: 0.7rem;
            }
            
            .chart-section.compact-mode .chart-artist {
                font-size: 0.6rem;
            }
            
            .chart-section.compact-mode .chart-stat {
                font-size: 0.55rem;
            }
            
            .chart-section.compact-mode .chart-stat.weeks,
            .chart-section.compact-mode .chart-stat.followers {
                width: 22px;
                padding: 0.1rem 0.15rem;
            }
        }
        
        /* Spotify embed modal */
        .spotify-embed-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }
        
        .spotify-embed-modal.active {
            display: flex;
        }
        
        .spotify-embed-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }
        
        .spotify-embed-content {
            position: relative;
            width: 90%;
            max-width: 400px;
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4),
                        inset 0 1px 0 rgba(255,255,255,0.15);
        }
        
        .spotify-embed-close {
            position: absolute;
            top: -14px;
            right: -14px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1DB954 0%, #169c46 100%);
            border: none;
            color: #fff;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.3);
        }
        
        .spotify-embed-close:hover {
            background: linear-gradient(135deg, #1ed760 0%, #1DB954 100%);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.3);
        }
        
        #spotify-embed-container iframe {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="compact chart-page">
    <header>
        <div class="header-content">
            <div class="logo-title-group">
                <span class="site-logo-text">MMM</span>
                <div class="title-group">
                    <h1>Македонска Музичка Топ Листа</h1>
                    <div class="subtitle-stats">
                        <span>Ажурирано пред <span id="last-updated">...</span></span>
                    </div>
                </div>
            </div>
            <div class="header-buttons">
                <button id="dark-mode-toggle" class="dark-mode-toggle" title="Темен/Светол режим">
                    <i class="fas fa-moon"></i>
                </button>
                <a href="list.html" class="header-btn" title="Листа"><i class="fas fa-list"></i></a>
                <button id="start-tour-btn" class="header-btn tour-btn" title="Тура"><i class="fas fa-globe"></i></button>
            </div>
        </div>
    </header>
    
    <div class="chart-container">
        
        <div class="chart-sections">
            <!-- Top Singles -->
            <div class="chart-section" id="singles-section">
                <div class="chart-section-header singles">
                    <h2><i class="fas fa-music"></i> Синглови</h2>
                    <div class="chart-header-right">
                        <span class="period" id="singles-period"></span>
                        <button class="view-mode-toggle" onclick="toggleViewMode('singles-section')" title="Компактен/Проширен приказ">
                            <i class="fas fa-compress-alt"></i>
                        </button>
                        <button class="share-btn" onclick="shareChart('singles')" title="Сподели">
                            <i class="fas fa-share-alt"></i> <span>Сподели</span>
                        </button>
                    </div>
                </div>
                <div class="chart-list-wrapper">
                    <div id="singles-chart-loading" class="chart-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Се вчитува...</p>
                    </div>
                    <ol id="singles-chart" class="chart-list" style="display: none;"></ol>
                    <div id="singles-chart-empty" class="chart-empty" style="display: none;">
                        <p>Нема синглови</p>
                    </div>
                </div>
            </div>
            
            <!-- Top Albums -->
            <div class="chart-section" id="albums-section">
                <div class="chart-section-header albums">
                    <h2><i class="fas fa-compact-disc"></i> Албуми</h2>
                    <div class="chart-header-right">
                        <span class="period" id="albums-period"></span>
                        <button class="view-mode-toggle" onclick="toggleViewMode('albums-section')" title="Компактен/Проширен приказ">
                            <i class="fas fa-compress-alt"></i>
                        </button>
                        <button class="share-btn" onclick="shareChart('albums')" title="Сподели">
                            <i class="fas fa-share-alt"></i> <span>Сподели</span>
                        </button>
                    </div>
                </div>
                <div class="chart-list-wrapper">
                    <div id="albums-chart-loading" class="chart-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Се вчитува...</p>
                    </div>
                    <ol id="albums-chart" class="chart-list" style="display: none;"></ol>
                    <div id="albums-chart-empty" class="chart-empty" style="display: none;">
                        <p>Нема албуми</p>
                    </div>
                </div>
            </div>
            
            <!-- Latest Releases -->
            <div class="chart-section" id="latest-section">
                <div class="chart-section-header">
                    <h2><i class="fas fa-clock"></i> Најнови</h2>
                    <div class="chart-header-right">
                        <span class="period" id="latest-period"></span>
                        <button class="view-mode-toggle" onclick="toggleViewMode('latest-section')" title="Компактен/Проширен приказ">
                            <i class="fas fa-compress-alt"></i>
                        </button>
                        <button class="share-btn" onclick="shareChart('latest')" title="Сподели">
                            <i class="fas fa-share-alt"></i> <span>Сподели</span>
                        </button>
                    </div>
                </div>
                <div class="chart-list-wrapper">
                    <div id="latest-chart-loading" class="chart-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Се вчитува...</p>
                    </div>
                    <ol id="latest-chart" class="chart-list" style="display: none;"></ol>
                    <div id="latest-chart-empty" class="chart-empty" style="display: none;">
                        <p>Нема изданија</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Modal -->
    <div class="share-modal" id="share-modal">
        <div class="share-modal-content">
            <div class="share-modal-header">
                <h3 id="share-modal-title">Сподели листа</h3>
                <button class="share-modal-close" onclick="closeShareModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="share-preview" id="share-preview"></div>
            <div class="share-actions">
                <button class="share-action-btn" onclick="shareToNative()" id="native-share-btn">
                    <i class="fas fa-share"></i> Сподели
                </button>
                <button class="share-action-btn download" onclick="downloadShareImage()">
                    <i class="fas fa-download"></i> Преземи
                </button>
                <button class="share-action-btn copy" onclick="copyShareImage()">
                    <i class="fas fa-copy"></i> Копирај
                </button>
            </div>
        </div>
    </div>
    
    <!-- Hidden container for share card rendering -->
    <div id="share-card-container"></div>
    
    <script>
        // Global state for sharing
        let chartDataStore = {
            singles: [],
            albums: [],
            latest: []
        };
        let currentShareBlob = null;
        let currentShareType = null;
        
        const chartTitles = {
            singles: 'Топ Синглови',
            albums: 'Топ Албуми',
            latest: 'Најнови Изданија'
        };
        
        // View mode toggle function
        function toggleViewMode(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            
            const isCompact = section.classList.toggle('compact-mode');
            const btn = section.querySelector('.view-mode-toggle');
            if (btn) {
                btn.innerHTML = isCompact 
                    ? '<i class="fas fa-expand-alt"></i>' 
                    : '<i class="fas fa-compress-alt"></i>';
                btn.title = isCompact ? 'Проширен приказ' : 'Компактен приказ';
            }
            
            // Save preference
            const prefs = JSON.parse(localStorage.getItem('mmm-view-mode') || '{}');
            prefs[sectionId] = isCompact;
            localStorage.setItem('mmm-view-mode', JSON.stringify(prefs));
        }
        
        // Initialize view modes based on screen size and saved preferences
        function initViewModes() {
            const isMobile = window.innerWidth <= 600;
            const prefs = JSON.parse(localStorage.getItem('mmm-view-mode') || '{}');
            
            ['singles-section', 'albums-section', 'latest-section'].forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (!section) return;
                
                // Use saved preference, or default to compact on mobile
                const shouldBeCompact = prefs[sectionId] !== undefined ? prefs[sectionId] : isMobile;
                
                if (shouldBeCompact) {
                    section.classList.add('compact-mode');
                    const btn = section.querySelector('.view-mode-toggle');
                    if (btn) {
                        btn.innerHTML = '<i class="fas fa-expand-alt"></i>';
                        btn.title = 'Проширен приказ';
                    }
                }
            });
        }
        
        const chartIcons = {
            singles: 'fa-music',
            albums: 'fa-compact-disc',
            latest: 'fa-clock'
        };
        
        // Share functions
        async function shareChart(chartType) {
            const btn = event.target.closest('.share-btn');
            if (btn) btn.classList.add('sharing');
            
            try {
                const releases = chartDataStore[chartType];
                if (!releases || releases.length === 0) {
                    alert('Нема податоци за споделување');
                    return;
                }
                
                // Create share card
                const canvas = await createShareCard(chartType, releases.slice(0, 10));
                
                // Convert to blob
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                currentShareBlob = blob;
                currentShareType = chartType;
                
                // Show preview modal
                const modal = document.getElementById('share-modal');
                const preview = document.getElementById('share-preview');
                const title = document.getElementById('share-modal-title');
                
                title.textContent = 'Сподели: ' + chartTitles[chartType];
                
                // Create preview image
                const img = document.createElement('img');
                img.src = URL.createObjectURL(blob);
                preview.innerHTML = '';
                preview.appendChild(img);
                
                // Check if native share is supported
                const nativeShareBtn = document.getElementById('native-share-btn');
                if (navigator.share && navigator.canShare) {
                    nativeShareBtn.style.display = 'flex';
                } else {
                    nativeShareBtn.style.display = 'none';
                }
                
                modal.classList.add('active');
                
            } catch (err) {
                console.error('Error creating share image:', err);
                alert('Грешка при креирање на сликата');
            } finally {
                if (btn) btn.classList.remove('sharing');
            }
        }
        
        async function createShareCard(chartType, releases) {
            const container = document.getElementById('share-card-container');
            const now = new Date();
            const monthNames = ['Јан', 'Фев', 'Мар', 'Апр', 'Мај', 'Јун', 'Јул', 'Авг', 'Сеп', 'Окт', 'Ное', 'Дек'];
            const dateStr = `${now.getDate()} ${monthNames[now.getMonth()]} ${now.getFullYear()}`;
            
            // Preload images to ensure they're available for html2canvas
            const imagePromises = releases.map(release => {
                if (!release.thumbnail) return Promise.resolve(null);
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => resolve(img);
                    img.onerror = () => resolve(null);
                    img.src = release.thumbnail;
                });
            });
            
            await Promise.all(imagePromises);
            
            container.innerHTML = `
                <div class="share-card" id="share-card-render">
                    <div class="share-card-header">
                        <div class="share-card-title">
                            <i class="fas ${chartIcons[chartType]}"></i>
                            ${chartTitles[chartType]}
                        </div>
                        <div class="share-card-branding">
                            <span class="mmm">MMM</span>
                            Македонска Музичка<br>Мастер Листа
                        </div>
                    </div>
                    <ul class="share-card-list">
                        ${releases.map((release, index) => {
                            const rank = index + 1;
                            const rankClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
                            return `
                                <li class="share-card-item">
                                    <span class="share-card-rank ${rankClass}">${rank}</span>
                                    <div class="share-card-cover">
                                        ${release.thumbnail 
                                            ? `<img src="${release.thumbnail}" crossorigin="anonymous" alt="">`
                                            : ''
                                        }
                                    </div>
                                    <div class="share-card-info">
                                        <div class="share-card-song">${release.releaseTitle}</div>
                                        <div class="share-card-artist">${release.bandName}</div>
                                    </div>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                    <div class="share-card-footer">
                        <div class="share-card-date">${dateStr}</div>
                        <div class="share-card-url">masterlista.martinpetkovski.com</div>
                    </div>
                </div>
            `;
            
            const card = document.getElementById('share-card-render');
            
            // Use html2canvas to render the card
            const canvas = await html2canvas(card, {
                backgroundColor: null,
                scale: 2,
                useCORS: true,
                allowTaint: true,
                logging: false
            });
            
            // Clean up
            container.innerHTML = '';
            
            return canvas;
        }
        
        function closeShareModal() {
            const modal = document.getElementById('share-modal');
            modal.classList.remove('active');
            currentShareBlob = null;
            currentShareType = null;
        }
        
        async function shareToNative() {
            if (!currentShareBlob) return;
            
            try {
                const file = new File([currentShareBlob], `mmm-${currentShareType}-chart.png`, { type: 'image/png' });
                
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: chartTitles[currentShareType],
                        text: `${chartTitles[currentShareType]} - Македонска Музичка Мастер Листа`
                    });
                } else {
                    // Fallback to just sharing URL/text
                    await navigator.share({
                        title: chartTitles[currentShareType],
                        text: `${chartTitles[currentShareType]} - Македонска Музичка Мастер Листа`,
                        url: window.location.href
                    });
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Share failed:', err);
                }
            }
        }
        
        function downloadShareImage() {
            if (!currentShareBlob) return;
            
            const url = URL.createObjectURL(currentShareBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mmm-${currentShareType}-chart.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        async function copyShareImage() {
            if (!currentShareBlob) return;
            
            try {
                await navigator.clipboard.write([
                    new ClipboardItem({
                        'image/png': currentShareBlob
                    })
                ]);
                
                // Show feedback
                const btn = event.target.closest('.share-action-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Копирано!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            } catch (err) {
                console.error('Copy failed:', err);
                alert('Не може да се копира. Пробајте да преземете.');
            }
        }
        
        // Close modal on background click
        document.getElementById('share-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('share-modal')) {
                closeShareModal();
            }
        });
        
        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeShareModal();
            }
        });
        
        document.addEventListener('DOMContentLoaded', async () => {
            const CHART_DATA_URL = 'chart-data.json';
            const CHART_HISTORY_DIR = 'chart-history';
            
            const now = new Date();
            const twoMonthsAgo = new Date(now);
            twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
            
            const monthNames = ['Јан', 'Фев', 'Мар', 'Апр', 'Мај', 'Јун', 'Јул', 'Авг', 'Сеп', 'Окт', 'Ное', 'Дек'];
            const periodText = `${monthNames[twoMonthsAgo.getMonth()]} - ${monthNames[now.getMonth()]}`;
            document.getElementById('singles-period').textContent = periodText;
            document.getElementById('albums-period').textContent = periodText;
            document.getElementById('latest-period').textContent = `последни 20`;
            
            // Store previous chart data for comparison
            let previousChartData = null;
            
            /**
             * Get ISO week number and year for a given date.
             */
            function getISOWeek(date) {
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);
                d.setDate(d.getDate() + 4 - (d.getDay() || 7));
                const yearStart = new Date(d.getFullYear(), 0, 1);
                const weekNum = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                return { year: d.getFullYear(), week: weekNum };
            }
            
            /**
             * Get the previous week's ISO week number and year.
             */
            function getPreviousWeek(date) {
                const d = new Date(date);
                d.setDate(d.getDate() - 7); // Go back 7 days
                return getISOWeek(d);
            }
            
            function formatDataAge(isoString) {
                if (!isoString) return null;
                const generatedAt = new Date(isoString);
                const ageMs = Date.now() - generatedAt.getTime();
                const hours = Math.floor(ageMs / (60 * 60 * 1000));
                const minutes = Math.floor((ageMs % (60 * 60 * 1000)) / (60 * 1000));
                if (hours >= 24) {
                    const days = Math.floor(hours / 24);
                    return `пред ${days}д`;
                }
                if (hours > 0) return `пред ${hours}ч`;
                return `пред ${minutes}мин`;
            }
            
            function updateDataInfo(generatedAt) {
                const lastUpdated = document.getElementById('last-updated');
                const age = formatDataAge(generatedAt);
                if (lastUpdated) lastUpdated.textContent = age || '...';
            }
            
            // Build a lookup map for previous chart positions
            function buildPreviousChartMap(previousReleases, filterFn, sortFn, deduplicateFn) {
                if (!previousReleases || previousReleases.length === 0) return {};
                
                // Deduplicate collabs in previous data too
                const dedupedReleases = deduplicateFn ? deduplicateFn(previousReleases) : previousReleases;
                
                const releasesSortedByDate = [...dedupedReleases].sort((a, b) => 
                    new Date(b.releaseDate).getTime() - new Date(a.releaseDate).getTime()
                );
                
                const filtered = releasesSortedByDate.filter(filterFn).slice(0, 20);
                const sorted = [...filtered].sort(sortFn);
                
                const map = {};
                sorted.forEach((release, index) => {
                    map[release.releaseId] = {
                        position: index + 1,
                        popularity: release.popularity || 0
                    };
                });
                return map;
            }
            
            // Scroll shadow detection
            function initScrollShadows() {
                document.querySelectorAll('.chart-list').forEach(list => {
                    const wrapper = list.closest('.chart-list-wrapper');
                    if (!wrapper) return;
                    
                    const updateShadows = () => {
                        const { scrollTop, scrollHeight, clientHeight } = list;
                        wrapper.classList.toggle('scroll-top', scrollTop > 5);
                        wrapper.classList.toggle('scroll-bottom', scrollTop < scrollHeight - clientHeight - 5);
                    };
                    
                    list.addEventListener('scroll', updateShadows);
                    // Initial check after render
                    setTimeout(updateShadows, 100);
                });
            }
            
            async function loadPreviousData() {
                // Calculate previous week's filename
                const prevWeek = getPreviousWeek(now);
                const prevWeekFileName = `chart-${prevWeek.year}-W${String(prevWeek.week).padStart(2, '0')}.json`;
                const prevWeekUrl = `${CHART_HISTORY_DIR}/${prevWeekFileName}`;
                
                try {
                    // Try to load last week's chart data from history
                    const response = await fetch(prevWeekUrl + '?t=' + Date.now());
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`Loaded previous week chart data: ${prevWeekFileName}`);
                        return data;
                    } else {
                        console.log(`Previous week data not found: ${prevWeekFileName}`);
                    }
                } catch (err) {
                    console.log('Could not load previous week chart data:', err.message);
                }
                
                return null;
            }
            
            // Merge collaborative releases (same releaseId = same track, different artists)
            function deduplicateCollabs(releases) {
                const releaseMap = new Map();
                
                releases.forEach(release => {
                    const existing = releaseMap.get(release.releaseId);
                    if (existing) {
                        // Merge artist names for collab (avoid duplicates)
                        const existingArtists = existing.bandName.split(', ');
                        if (!existingArtists.includes(release.bandName)) {
                            existing.bandName = existingArtists.concat(release.bandName).join(', ');
                        }
                        // Keep the higher popularity and follower count
                        existing.popularity = Math.max(existing.popularity || 0, release.popularity || 0);
                        existing.followers = Math.max(existing.followers || 0, release.followers || 0);
                        // Mark as collab
                        existing.isCollab = true;
                    } else {
                        // Clone the release to avoid mutating the original
                        releaseMap.set(release.releaseId, { ...release });
                    }
                });
                
                return Array.from(releaseMap.values());
            }
            
            async function loadChartData() {
                let releases = [];
                let generatedAt = null;
                
                // Load previous data for comparison
                previousChartData = await loadPreviousData();
                
                try {
                    const response = await fetch(CHART_DATA_URL + '?t=' + Date.now());
                    if (response.ok) {
                        const chartData = await response.json();
                        releases = chartData.releases || [];
                        generatedAt = chartData.generatedAt;
                        console.log('Loaded', releases.length, 'releases from chart-data.json');
                        
                        // Previous week data is now managed by the generate script
                    } else {
                        console.warn('chart-data.json returned status:', response.status);
                    }
                } catch (err) {
                    console.warn('Could not load chart-data.json:', err);
                }
                
                if (releases.length === 0) {
                    console.warn('No releases found in chart-data.json');
                }
                
                // Deduplicate collaborative releases (same releaseId appearing for multiple artists)
                releases = deduplicateCollabs(releases);
                console.log('After deduplication:', releases.length, 'unique releases');
                
                updateDataInfo(generatedAt);
                document.querySelectorAll('.chart-loading').forEach(el => el.style.display = 'none');
                
                // Sort all releases by date (most recent first)
                const releasesSortedByDate = [...releases].sort((a, b) => 
                    new Date(b.releaseDate).getTime() - new Date(a.releaseDate).getTime()
                );
                
                const sortByPopularity = (a, b) => (b.popularity || 0) - (a.popularity || 0);
                
                // Top Singles: 20 most recent singles, then sorted by track popularity
                const singlesFilter = r => r.releaseType === 'single';
                const topSingles = releasesSortedByDate
                    .filter(singlesFilter)
                    .slice(0, 20)
                    .sort(sortByPopularity);
                
                // Top Albums: 20 most recent albums/compilations, then sorted by track popularity
                const albumsFilter = r => r.releaseType === 'album' || r.releaseType === 'compilation';
                const topAlbums = releasesSortedByDate
                    .filter(albumsFilter)
                    .slice(0, 20)
                    .sort(sortByPopularity);
                
                // Latest: 20 most recent releases, sorted by date (newest first)
                const latestReleases = releasesSortedByDate.slice(0, 20);
                
                // Build previous chart maps for comparison (also deduplicate collabs)
                const prevReleases = previousChartData?.releases || [];
                const prevSinglesMap = buildPreviousChartMap(prevReleases, singlesFilter, sortByPopularity, deduplicateCollabs);
                const prevAlbumsMap = buildPreviousChartMap(prevReleases, albumsFilter, sortByPopularity, deduplicateCollabs);
                // For latest, we don't track position changes since it's date-sorted
                
                renderChart('singles-chart', topSingles, prevSinglesMap);
                renderChart('albums-chart', topAlbums, prevAlbumsMap);
                renderChart('latest-chart', latestReleases, {}, true);
                
                // Store chart data for sharing
                chartDataStore.singles = topSingles;
                chartDataStore.albums = topAlbums;
                chartDataStore.latest = latestReleases;
                
                // Initialize scroll shadows after rendering
                initScrollShadows();
            }
            
            function renderChart(containerId, releases, previousMap = {}, isDateSorted = false) {
                const container = document.getElementById(containerId);
                const loading = document.getElementById(`${containerId}-loading`);
                const empty = document.getElementById(`${containerId}-empty`);
                
                loading.style.display = 'none';
                
                if (releases.length === 0) {
                    empty.style.display = 'block';
                    return;
                }
                
                container.style.display = 'block';
                container.innerHTML = releases.map((release, index) => {
                    const rank = index + 1;
                    const rankClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
                    let itemClass = rank <= 3 ? `rank-${rank}` : '';
                    
                    const popularity = release.popularity || 0;
                    
                    // Calculate time since release (smart formatting)
                    const releaseDate = new Date(release.releaseDate);
                    const now = new Date();
                    const msElapsed = now - releaseDate;
                    const hoursElapsed = Math.floor(msElapsed / (60 * 60 * 1000));
                    const daysElapsed = Math.floor(msElapsed / (24 * 60 * 60 * 1000));
                    const weeksElapsed = Math.floor(daysElapsed / 7);
                    
                    let timeSinceRelease, timeSinceTitle;
                    if (weeksElapsed >= 1) {
                        timeSinceRelease = `${weeksElapsed}н`;
                        timeSinceTitle = `${weeksElapsed} недел${weeksElapsed === 1 ? 'а' : 'и'} од издавање`;
                    } else if (daysElapsed >= 1) {
                        timeSinceRelease = `${daysElapsed}д`;
                        timeSinceTitle = `${daysElapsed} ден${daysElapsed === 1 ? '' : 'а'} од издавање`;
                    } else {
                        timeSinceRelease = `${Math.max(1, hoursElapsed)}ч`;
                        timeSinceTitle = `${Math.max(1, hoursElapsed)} час${hoursElapsed === 1 ? '' : 'а'} од издавање`;
                    }
                    
                    // Format release date for display
                    const monthNames = ['Јан', 'Фев', 'Мар', 'Апр', 'Мај', 'Јун', 'Јул', 'Авг', 'Сеп', 'Окт', 'Ное', 'Дек'];
                    const releaseDateStr = `${releaseDate.getDate()} ${monthNames[releaseDate.getMonth()]}`;
                    
                    // Get Spotify ID for embed
                    const spotifyMatch = (release.topTrackUrl || release.releaseUrl || '').match(/spotify\.com\/(track|album)\/([a-zA-Z0-9]+)/);
                    const spotifyType = spotifyMatch ? spotifyMatch[1] : null;
                    const spotifyId = spotifyMatch ? spotifyMatch[2] : null;
                    
                    // Check for changes from previous chart (skip for date-sorted)
                    let changeIndicator = '';
                    let popChangeIndicator = '';
                    
                    if (!isDateSorted) {
                        const prev = previousMap[release.releaseId];
                        if (!prev) {
                            // New entry
                            itemClass += ' is-new';
                            changeIndicator = `<div class="chart-change new" title="Ново"><i class="fas fa-star"></i></div>`;
                            popChangeIndicator = '';
                        } else {
                            // Position change
                            const posChange = prev.position - rank;
                            if (posChange > 0) {
                                changeIndicator = `<div class="chart-change up" title="Се качи за ${posChange}"><i class="fas fa-caret-up"></i><span class="change-value">${posChange}</span></div>`;
                            } else if (posChange < 0) {
                                changeIndicator = `<div class="chart-change down" title="Падна за ${Math.abs(posChange)}"><i class="fas fa-caret-down"></i><span class="change-value">${Math.abs(posChange)}</span></div>`;
                            } else {
                                changeIndicator = `<div class="chart-change same" title="Без промена"><i class="fas fa-minus"></i></div>`;
                            }
                            
                            // Popularity change - only show if changed
                            const popDiff = popularity - prev.popularity;
                            if (popDiff > 0) {
                                popChangeIndicator = `<span class="pop-change up" title="Зголемена популарност">+${popDiff}</span>`;
                            } else if (popDiff < 0) {
                                popChangeIndicator = `<span class="pop-change down" title="Намалена популарност">${popDiff}</span>`;
                            } else {
                                popChangeIndicator = '';
                            }
                        }
                    }
                    
                    // Time since release stat
                    const metaContent = `<span class="chart-stat weeks" title="${timeSinceTitle}">${timeSinceRelease}</span>`;
                    
                    // For date-sorted charts, hide position and change indicators
                    const showPosition = !isDateSorted;
                    
                    return `
                        <li class="chart-item ${itemClass}">
                            ${showPosition ? `<span class="chart-rank ${rankClass}">${rank}</span>` : ''}
                            ${showPosition ? changeIndicator : ''}
                            <div class="chart-cover">
                                ${release.thumbnail 
                                    ? `<img src="${release.thumbnail}" alt="${release.releaseTitle}" loading="lazy" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'placeholder\\'><i class=\\'fab fa-spotify\\'></i></div>'">`
                                    : '<div class="placeholder"><i class="fab fa-spotify"></i></div>'
                                }
                            </div>
                            <div class="chart-info">
                                <div class="chart-title" ${spotifyId ? `data-spotify-id="${spotifyId}" data-spotify-type="${spotifyType}"` : `data-url="${release.topTrackUrl || release.releaseUrl}"`} title="Кликни за преслушување">${release.releaseTitle}</div>
                                <div class="chart-artist">${release.artistUrl 
                                    ? `<a href="${release.artistUrl}" target="_blank" class="chart-artist-link" title="Отвори артист во Spotify">${release.bandName}</a>`
                                    : release.bandName
                                }</div>
                            </div>
                            <div class="chart-meta">
                                ${metaContent}
                                <span class="chart-stat followers" title="Популарност"><i class="fas fa-fire"></i>${popularity}${popChangeIndicator}</span>
                            </div>
                        </li>
                    `;
                }).join('');
                
                // Add click listeners for track titles to play
                container.querySelectorAll('.chart-title[data-spotify-id]').forEach(title => {
                    title.addEventListener('click', (e) => {
                        e.preventDefault();
                        const spotifyId = title.dataset.spotifyId;
                        const spotifyType = title.dataset.spotifyType;
                        showSpotifyEmbed(spotifyId, spotifyType);
                    });
                });
                
                // Fallback for titles without Spotify ID - open URL
                container.querySelectorAll('.chart-title[data-url]').forEach(title => {
                    title.addEventListener('click', (e) => {
                        e.preventDefault();
                        const url = title.dataset.url;
                        if (url) window.open(url, '_blank');
                    });
                });
            }
            
            // Spotify embed modal functionality
            function showSpotifyEmbed(spotifyId, type = 'track') {
                let modal = document.getElementById('spotify-embed-modal');
                
                if (!modal) {
                    // Create modal if it doesn't exist
                    modal = document.createElement('div');
                    modal.id = 'spotify-embed-modal';
                    modal.className = 'spotify-embed-modal';
                    modal.innerHTML = `
                        <div class="spotify-embed-backdrop"></div>
                        <div class="spotify-embed-content">
                            <button class="spotify-embed-close"><i class="fas fa-times"></i></button>
                            <div id="spotify-embed-container"></div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    // Close on backdrop click
                    modal.querySelector('.spotify-embed-backdrop').addEventListener('click', closeSpotifyEmbed);
                    modal.querySelector('.spotify-embed-close').addEventListener('click', closeSpotifyEmbed);
                    
                    // Close on Escape
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && modal.classList.contains('active')) {
                            closeSpotifyEmbed();
                        }
                    });
                }
                
                const container = document.getElementById('spotify-embed-container');
                const embedUrl = `https://open.spotify.com/embed/${type}/${spotifyId}?utm_source=generator&theme=0`;
                
                container.innerHTML = `
                    <iframe 
                        src="${embedUrl}" 
                        width="100%" 
                        height="${type === 'track' ? '152' : '352'}" 
                        frameBorder="0" 
                        allowfullscreen="" 
                        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                        loading="lazy"
                    ></iframe>
                `;
                
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            function closeSpotifyEmbed() {
                const modal = document.getElementById('spotify-embed-modal');
                const container = document.getElementById('spotify-embed-container');
                
                if (modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
                if (container) {
                    container.innerHTML = '';
                }
            }
            
            loadChartData();
            
            // ==================== DARK MODE ====================
            function initDarkMode() {
                const toggle = document.getElementById('dark-mode-toggle');
                if (!toggle) return;
                
                // Check localStorage for saved preference
                const savedMode = localStorage.getItem('mmm-dark-mode');
                if (savedMode === 'true') {
                    document.body.classList.add('dark-mode');
                    toggle.innerHTML = '<i class="fas fa-sun"></i>';
                }
                
                toggle.addEventListener('click', () => {
                    document.body.classList.toggle('dark-mode');
                    const isDark = document.body.classList.contains('dark-mode');
                    localStorage.setItem('mmm-dark-mode', isDark);
                    toggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                });
            }
            
            initDarkMode();
            
            // Initialize view modes after DOM is ready
            initViewModes();
            
            // ==================== TOUR FUNCTIONALITY ====================
            // Check if mobile
            const isMobile = () => window.innerWidth <= 600;
            
            const tourSteps = [
                {
                    element: null,
                    title: 'Македонска Музичка Топ Листа',
                    description: 'Преглед на најновите изданија од македонски артисти. Листите се ажурираат автоматски секој ден врз основа на Spotify податоци.',
                    position: 'center'
                },
                {
                    element: '#singles-section .chart-section-header',
                    title: 'Синглови',
                    description: 'Најпопуларни синглови од последните два месеци, рангирани според популарност на Spotify.',
                    position: 'bottom',
                    mobilePosition: 'bottom'
                },
                {
                    element: '#albums-section .chart-section-header',
                    title: 'Албуми',
                    description: 'Нови албуми и EP изданија од македонски артисти во истиот период.',
                    position: 'bottom',
                    mobilePosition: 'bottom'
                },
                {
                    element: '#latest-section .chart-section-header',
                    title: 'Најнови',
                    description: 'Последните 20 изданија подредени по датум на објава - од најново кон најстаро.',
                    position: 'bottom',
                    mobilePosition: 'bottom'
                },
                {
                    element: '.chart-item',
                    title: 'Детали за издание',
                    description: 'Секое издание содржи корица, наслов, артист и популарност. Стрелките покажуваат промена во позицијата од минатата недела.',
                    position: 'bottom',
                    mobilePosition: 'bottom'
                },
                {
                    element: '.view-mode-toggle',
                    title: 'Компактен приказ',
                    description: 'Менувајте помеѓу компактен и проширен приказ. На мобилни уреди стандардно е компактен.',
                    position: 'bottom',
                    mobilePosition: 'bottom'
                },
                {
                    element: 'a.header-btn[href="list.html"]',
                    title: 'База на артисти',
                    description: 'Пристап до комплетната база на македонски музички артисти со филтри и детални информации.',
                    position: 'bottom',
                    mobilePosition: 'bottom'
                }
            ];

            let currentTourStep = 0;
            let tourActive = false;

            function initTour() {
                const tourBtn = document.getElementById('start-tour-btn');
                if (!tourBtn) return;

                // Create tour overlay if not exists
                if (!document.getElementById('tour-overlay')) {
                    const overlay = document.createElement('div');
                    overlay.id = 'tour-overlay';
                    overlay.className = 'tour-overlay';
                    overlay.innerHTML = `
                        <div class="tour-highlight"></div>
                        <div class="tour-tooltip">
                            <div class="tour-tooltip-content">
                                <h3 class="tour-title"></h3>
                                <p class="tour-description"></p>
                            </div>
                            <div class="tour-footer">
                                <span class="tour-progress"></span>
                                <div class="tour-buttons">
                                    <button class="tour-btn-skip">Прескокни</button>
                                    <button class="tour-btn-prev"><i class="fas fa-arrow-left"></i></button>
                                    <button class="tour-btn-next">Следно <i class="fas fa-arrow-right"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(overlay);
                }

                const overlay = document.getElementById('tour-overlay');
                const tooltip = overlay.querySelector('.tour-tooltip');
                const prevBtn = tooltip.querySelector('.tour-btn-prev');
                const nextBtn = tooltip.querySelector('.tour-btn-next');
                const skipBtn = tooltip.querySelector('.tour-btn-skip');

                tourBtn.addEventListener('click', startTour);
                prevBtn.addEventListener('click', prevStep);
                nextBtn.addEventListener('click', nextStep);
                skipBtn.addEventListener('click', endTour);

                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay || e.target.classList.contains('tour-highlight')) {
                        endTour();
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (!tourActive) return;
                    if (e.key === 'Escape') endTour();
                    if (e.key === 'ArrowRight' || e.key === 'Enter') nextStep();
                    if (e.key === 'ArrowLeft') prevStep();
                });
            }

            function startTour() {
                tourActive = true;
                currentTourStep = 0;
                document.getElementById('tour-overlay').classList.add('active');
                // On mobile, allow scrolling to see elements; on desktop, prevent scroll
                if (!isMobile()) {
                    document.body.style.overflow = 'hidden';
                }
                showTourStep(currentTourStep);
            }

            function endTour() {
                tourActive = false;
                document.getElementById('tour-overlay').classList.remove('active');
                document.body.style.overflow = '';
            }

            function prevStep() {
                if (currentTourStep > 0) {
                    currentTourStep--;
                    showTourStep(currentTourStep);
                }
            }

            function nextStep() {
                if (currentTourStep < tourSteps.length - 1) {
                    currentTourStep++;
                    showTourStep(currentTourStep);
                } else {
                    endTour();
                }
            }

            function showTourStep(stepIndex) {
                const step = tourSteps[stepIndex];
                const overlay = document.getElementById('tour-overlay');
                const highlight = overlay.querySelector('.tour-highlight');
                const tooltip = overlay.querySelector('.tour-tooltip');
                const titleEl = tooltip.querySelector('.tour-title');
                const descEl = tooltip.querySelector('.tour-description');
                const progressEl = tooltip.querySelector('.tour-progress');
                const prevBtn = tooltip.querySelector('.tour-btn-prev');
                const nextBtn = tooltip.querySelector('.tour-btn-next');

                titleEl.textContent = step.title;
                descEl.innerHTML = step.description;
                progressEl.textContent = `${stepIndex + 1} / ${tourSteps.length}`;

                prevBtn.disabled = stepIndex === 0;
                nextBtn.innerHTML = stepIndex === tourSteps.length - 1 
                    ? 'Заврши <i class="fas fa-check"></i>' 
                    : 'Следно <i class="fas fa-arrow-right"></i>';

                tooltip.classList.remove('arrow-top', 'arrow-bottom', 'arrow-left', 'arrow-right', 'tour-center');

                // On mobile, use bottom sheet style - hide highlight and let CSS handle tooltip
                if (isMobile()) {
                    highlight.style.display = 'none';
                    tooltip.style.top = '';
                    tooltip.style.left = '';
                    
                    // Scroll target element into view if it exists
                    const targetEl = step.element ? document.querySelector(step.element) : null;
                    if (targetEl) {
                        targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    return;
                }

                if (step.position === 'center' || !step.element) {
                    highlight.style.display = 'none';
                    tooltip.classList.add('tour-center');
                    tooltip.style.top = '';
                    tooltip.style.left = '';
                } else {
                    const targetEl = document.querySelector(step.element);
                    if (!targetEl) {
                        if (stepIndex < tourSteps.length - 1) {
                            currentTourStep++;
                            showTourStep(currentTourStep);
                        }
                        return;
                    }

                    setTimeout(() => {
                        positionHighlight(targetEl, highlight);
                        positionTooltip(targetEl, tooltip, step.position);
                    }, 50);
                }
            }

            function positionHighlight(element, highlight) {
                const rect = element.getBoundingClientRect();
                const padding = 4;
                highlight.style.display = 'block';
                highlight.style.top = (rect.top - padding) + 'px';
                highlight.style.left = (rect.left - padding) + 'px';
                highlight.style.width = (rect.width + padding * 2) + 'px';
                highlight.style.height = (rect.height + padding * 2) + 'px';
            }

            function positionTooltip(element, tooltip, position) {
                const rect = element.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();
                const gap = 16;
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;

                if (viewportWidth <= 600) {
                    tooltip.classList.add('arrow-top');
                    return;
                }

                let top, left;
                let arrowClass = '';

                switch (position) {
                    case 'bottom':
                        top = rect.bottom + gap;
                        left = rect.left + rect.width / 2 - tooltipRect.width / 2;
                        arrowClass = 'arrow-top';
                        break;
                    case 'top':
                        top = rect.top - tooltipRect.height - gap;
                        left = rect.left + rect.width / 2 - tooltipRect.width / 2;
                        arrowClass = 'arrow-bottom';
                        break;
                    case 'left':
                        top = rect.top + rect.height / 2 - tooltipRect.height / 2;
                        left = rect.left - tooltipRect.width - gap;
                        arrowClass = 'arrow-right';
                        break;
                    case 'right':
                        top = rect.top + rect.height / 2 - tooltipRect.height / 2;
                        left = rect.right + gap;
                        arrowClass = 'arrow-left';
                        break;
                }

                if (left < 10) left = 10;
                if (left + tooltipRect.width > viewportWidth - 10) left = viewportWidth - tooltipRect.width - 10;
                if (top < 10) top = 10;
                if (top + tooltipRect.height > viewportHeight - 10) top = viewportHeight - tooltipRect.height - 10;

                tooltip.style.top = top + 'px';
                tooltip.style.left = left + 'px';
                tooltip.classList.add(arrowClass);
            }

            initTour();
        });
    </script>
</body>
</html>
